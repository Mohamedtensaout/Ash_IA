<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ash.ia Vpro- Assistant IA Persistant</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, updateDoc, doc, onSnapshot, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services globally for use in the main script block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, query, orderBy, limit, getDocs, addDoc, updateDoc, doc, onSnapshot, deleteDoc, serverTimestamp
        };
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Styles personnalis√©s pour le d√©filement */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }

        /* Styles suppl√©mentaires pour la visibilit√© des ic√¥nes/emojis */
        .icon-content {
            font-family: 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;
            display: inline-block;
        }

        /* Style pour les formules math√©matiques (simule l'effet MathJax sans le charger) */
        .math-block {
            display: block;
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
    </style>
    
</head>
<body class="p-0 m-0 overflow-hidden">

    <div id="root" class="h-screen w-screen">
        </div>

    <script type="text/babel">
        
        // --------------------------------------------------------------------------------------------------
        // CODE REACT INTEGRAL DE L'APPLICATION ASH.IA
        // --------------------------------------------------------------------------------------------------
        
        // ==================================================================================================
        // üõëüõëüõë ATTENTION CRITIQUE : CL√â API ET MOD√àLE üõëüõëüõë
        // ==================================================================================================
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        
        // Cl√© API de l'utilisateur.
        const API_KEY = "AIzaSyCz1Pl84NaoLXz5_xFWFtz11NYk7P5dGg4"; 
        
        // L'URL de l'API est construite avec le mod√®le sp√©cifi√©.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 3;
        // ==================================================================================================

        const { useState, useEffect, useRef } = React;
        
        // --- SIMULATION D'IC√îNES LUCIDE-REACT ---
        const Icon = ({ name, className, children }) => {
            let IconContent;
            switch(name) {
                case 'Send': IconContent = '‚û§'; break;
                case 'CheckCircle': IconContent = '‚úÖ'; break;
                case 'GraduationCap': IconContent = 'üéì'; break;
                case 'Briefcase': IconContent = 'üíº'; break;
                case 'Loader': IconContent = '‚è≥'; break;
                case 'ExternalLink': IconContent = 'üîó'; break;
                case 'Menu': IconContent = '‚ò∞'; break;
                case 'X': IconContent = '‚úñ'; break;
                case 'Trash2': IconContent = 'üóëÔ∏è'; break;
                case 'PlusCircle': IconContent = '‚ûï'; break;
                case 'Settings': IconContent = '‚öôÔ∏è'; break;
                case 'Edit2': IconContent = '‚úé'; break;
                case 'Globe': IconContent = 'üåê'; break;
                case 'Bookmark': IconContent = 'üîñ'; break;
                case 'Zap': IconContent = '‚ö°'; break;
                case 'Paperclip': IconContent = 'üìé'; break; 
                case 'Clipboard': IconContent = 'üìã'; break; // Nouvelle ic√¥ne
                case 'RefreshCw': IconContent = 'üîÑ'; break; // Nouvelle ic√¥ne
                default: IconContent = name;
            }
            return <span className={`inline-block icon-content ${className}`}>{IconContent}{children}</span>;
        };
        
        // Helper to format source links
        const formatSource = (source) => {
            if (source.uri && source.title) {
                return `[${source.title}](${source.uri})`;
            }
            return '';
        };
        
        // Utility function to convert File to Base64
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Extract only the Base64 data (after the comma)
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        };
        
        // Utility function to copy text (using execCommand for iframe compatibility)
        const copyToClipboard = (text) => {
             const el = document.createElement('textarea');
             el.value = text;
             document.body.appendChild(el);
             el.select();
             document.execCommand('copy');
             document.body.removeChild(el);
             // Note: Un feedback visuel (toast ou changement d'ic√¥ne) serait id√©al ici
             console.log("Copied to clipboard:", text);
        };

        // --- TRADUCTIONS DE L'INTERFACE UTILISATEUR ---
        const translations = {
            fr: {
                nicknamePlaceholder: "Votre pseudo (Ex: UserX)",
                profileLabel: "Profil d'Interaction (Optionnel)",
                student: "√âtudiant",
                professional: "Professionnel",
                themeLabel: "Th√®me de l'Application",
                darkMode: "Sombre",
                lightMode: "Clair",
                neonMode: "N√©on Bleu Nuit",
                settingsTitle: "Param√®tres de l'Application",
                continueButton: "Continuer",
                startButton: "Commencer le Chat",
                authStatus: "Authentification OK",
                authLoading: "Chargement de l'authentification...",
                sidebarTitle: "Historique",
                newChat: "Nouveau Chat Standard",
                newProject: "Nouveau Projet (Sauvegard√©)",
                newEphemeral: "Chat Temporaire",
                noSavedChats: "Commencez une conversation pour la sauvegarder.",
                typeStudent: "√âtudiant",
                typeProfessional: "Professionnel",
                typeGeneral: "G√©n√©ral",
                renameChatTitle: "Renommer le Chat",
                newTitlePlaceholder: "Nouveau titre du chat",
                cancel: "Annuler",
                close: "Fermer", 
                save: "Sauvegarder", 
                openHistory: "Ouvrir l'historique",
                settings: "Param√®tres",
                startNewChat: "D√©marrer un Nouveau Chat",
                welcomeMessage: (pseudo) => `Le fondateur Ash-Shishani vous souhaite la bienvenue ${pseudo}, posez-moi une question !`,
                profileSelected: (userTypeLabel) => `Votre profil ${userTypeLabel} est s√©lectionn√©. Posez votre premi√®re question pour d√©marrer un chat.`,
                profileGeneral: "Aucun profil s√©lectionn√©. Vous √™tes en mode G√©n√©ral.",
                useMenu: "Utilisez le menu pour charger vos conversations.",
                sendPlaceholder: "Envoyer un message √† Ash.ia...",
                thinking: ".... Ash r√©fl√©chi", 
                sources: "Sources:",
                criticalError: "Une erreur critique est survenue.",
                apiError: "Ash.ia a rencontr√© une difficult√© pour g√©n√©rer une r√©ponse. Que d√©sirez-vous savoir d'autre ?",
                apiConnectionError: "Ash.ia n'a pas pu se connecter pour le moment. Veuillez r√©essayer. Quel sujet voulez-vous aborder ?",
                apiRestrictionError: "ERREUR 403 (Acc√®s Refus√©): L'API a bloqu√© l'acc√®s. Votre cl√© est valide (confirm√© par cURL), mais elle a **tr√®s probablement une restriction de r√©f√©rant HTTP (HTTP referrer) qui bloque l'acc√®s depuis ce site web.** Veuillez retirer toute restriction sur votre cl√© API dans la console Google.",
                language: "Langue de l'Interface",
                resetSettings: "R√©initialiser le Profil & Pseudo",
                resetConfirm: "R√©initialiser le pseudo et le profil ?",
                nicknameRequired: "Veuillez entrer un pseudo.",
                deleteChat: "Supprimer le Chat",
                keyError: (length) => `ERREUR API: La cl√© API est trop courte ou invalide. Longueur actuelle: ${length}. Une cl√© compl√®te est n√©cessaire.`,
                persistedChat: "Conversations Sauvegard√©es",
                chatDeleteConfirm: "√ätes-vous s√ªr de vouloir supprimer cette conversation ?",
                imageUpload: "Image pr√™te √† √™tre envoy√©e (cliquez pour annuler)",
                copyMessage: "Copier le message", // Nouvelle traduction
                reformulateMessage: "Demander une reformulation", // Nouvelle traduction
            },
            en: {
                nicknamePlaceholder: "Your Nickname (Ex: UserX)",
                profileLabel: "Interaction Profile (Optional)",
                profileLabel: "Interaction Profile (Optional)",
                student: "Student",
                professional: "Professional",
                themeLabel: "Application Theme",
                darkMode: "Dark",
                lightMode: "Light",
                neonMode: "Neon Blue Night",
                settingsTitle: "Application Settings",
                continueButton: "Continue",
                startButton: "Start Chat",
                authStatus: "Authentication OK",
                authLoading: "Authentication loading...",
                sidebarTitle: "History",
                newChat: "New Standard Chat",
                newProject: "New Project (Saved)",
                newEphemeral: "Temporary Chat",
                noSavedChats: "Start a conversation to save it.",
                typeStudent: "Student",
                typeProfessional: "Professional",
                typeGeneral: "General",
                renameChatTitle: "Rename Chat",
                newTitlePlaceholder: "New chat title",
                cancel: "Cancel",
                close: "Close", 
                save: "Save", 
                openHistory: "Open History",
                settings: "Settings",
                startNewChat: "Start New Chat",
                welcomeMessage: (pseudo) => `Founder Ash-Shishani welcomes you ${pseudo}, ask me a question!`,
                profileSelected: (userTypeLabel) => `Your ${userTypeLabel} profile is selected. Ask your first question to start a chat.`,
                profileGeneral: "No profile selected. You are in General mode.",
                useMenu: "Use the menu to load your conversations.",
                sendPlaceholder: "Send a message to Ash.ia...",
                thinking: ".... Ash is thinking", 
                sources: "Sources:",
                criticalError: "A critical error occurred.",
                apiError: "Ash.ia encountered a difficulty generating a response. What else would you like to know?",
                apiConnectionError: "Ash.ia could not connect at this time. Please try again. What topic do you want to discuss?",
                apiRestrictionError: "ERROR 403 (Forbidden Access): The API blocked access. Your key is valid (confirmed by cURL), but it **most likely has an HTTP referrer restriction that blocks access from this website.** Please remove any restrictions on your API key in the Google console.",
                language: "Interface Language",
                resetSettings: "Reset Profile & Nickname",
                resetConfirm: "Reset nickname and profile?",
                nicknameRequired: "Please enter a nickname.",
                deleteChat: "Delete Chat",
                keyError: (length) => `API ERROR: The API key is too short or invalid. Current length: ${length}. A complete key is required.`,
                persistedChat: "Saved Conversations",
                chatDeleteConfirm: "Are you sure you want to delete this conversation?",
                imageUpload: "Image ready to send (click to cancel)",
                copyMessage: "Copy message",
                reformulateMessage: "Request reformulation",
            }
        };


        // --- COMPOSANT PRINCIPAL DE L'APPLICATION ---
        const App = () => {
            // UI States
            const [language, setLanguage] = useState('fr'); 
            const t = translations[language]; 
            
            // userType peut √™tre null (mode G√©n√©ral)
            const [userType, setUserType] = useState(null); 
            const [theme, setTheme] = useState('dark'); 
            const [nickname, setNickname] = useState(''); 
            const [isMenuOpen, setIsMenuOpen] = useState(false); // Sidebar
            const [isNewChatMenuOpen, setIsNewChatMenuOpen] = useState(false); // Menu + button
            
            // Gestion des modales
            const [isNicknameModalOpen, setIsNicknameModalOpen] = useState(true); 
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false); 

            // Chat States
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [currentChatId, setCurrentChatId] = useState(null);
            const [chats, setChats] = useState([]); // Liste des chats pour la sidebar
            const [chatType, setChatType] = useState('standard'); // 'standard' or 'ephemeral'

            // States for title editing
            const [isTitleEditModalOpen, setIsTitleEditModalOpen] = useState(false);
            const [chatToEdit, setChatToEdit] = useState(null);
            
            // File Upload States & Ref
            const fileInputRef = useRef(null);
            const [uploadedImage, setUploadedImage] = useState(null); // { base64: '...', mimeType: 'image/png' }


            // Firebase States
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            
            const messagesEndRef = useRef(null);
            
            const isTyping = input.length > 0;
            
            // --- CONSTANTES FIREBASE ---
            const CHAT_COLLECTION = 'chats'; 
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // --- FONCTIONS UTILS FIREBASE ---
            const getChatCollectionRef = (dbInstance, currentUserId) => {
                return window.firebase.collection(dbInstance, `artifacts/${appId}/users/${currentUserId}/${CHAT_COLLECTION}`);
            };
            
            // --- LOGIQUE DE TH√àME ET STYLES ---

            const CustomStyles = () => (
                <style>{`
                    /* Ombre de texte pour la nuance de couleur des caract√®res (plus joli) */
                    .neon-text-shadow {
                         /* Subtile ombre blanche/indigo pour l'effet 'n√©on' l√©ger */
                         text-shadow: 0 0 1px rgba(255, 255, 255, 0.1), 0 0 4px rgba(129, 140, 248, 0.2); 
                    }
                    
                    /* Correction de la police pour les ic√¥nes remplac√©es par des emojis */
                    .icon-content {
                        font-family: 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;
                        display: inline-block;
                    }
                `}</style>
            );

            const getThemeClasses = (element) => {
                const bgAppClass = 'bg-gray-950';

                switch (theme) {
                    case 'light':
                        if (element === 'bg-main') return 'bg-gray-100 text-gray-800'; 
                        if (element === 'bg-app') return bgAppClass; 
                        if (element === 'bg-sidebar') return 'bg-white border-r border-gray-200 text-gray-800';
                        if (element === 'bg-header') return 'bg-white shadow-lg';
                        if (element === 'bg-modal') return 'bg-white'; 
                        if (element === 'text-primary') return 'text-indigo-600';
                        if (element === 'bg-input') return 'bg-gray-200 text-gray-800 border-gray-300';
                        if (element === 'bg-user') return 'bg-blue-600 text-white shadow-lg shadow-blue-500/30';
                        if (element === 'bg-ash') return 'bg-white text-gray-900 border border-gray-200 shadow-md';
                        if (element === 'bg-chat-card') return 'bg-gray-200'; 
                        if (element === 'btn-primary') return 'bg-indigo-600 hover:bg-indigo-700 text-white';
                        if (element === 'btn-secondary') return 'bg-gray-300 hover:bg-gray-400 text-gray-800';
                        return '';
                    case 'neon': 
                        const NEON_BG = 'bg-[#0A0A2A]'; // Bleu Nuit
                        const NEON_USER_BG = 'bg-indigo-700'; // Fond message utilisateur
                        const NEON_ASH_BG = 'bg-gray-800'; // Fond message ASH
                        const NEON_SHADOW = 'shadow-indigo-500/30';

                        if (element === 'bg-main') return `${NEON_BG} text-gray-50`;
                        if (element === 'bg-app') return NEON_BG;
                        if (element === 'bg-sidebar') return `${NEON_BG} border-r border-indigo-800 text-gray-50`;
                        if (element === 'bg-header') return `${NEON_BG} shadow-xl`;
                        if (element === 'bg-modal') return `${NEON_BG}/95`; 
                        if (element === 'text-primary') return 'text-indigo-400';
                        if (element === 'bg-input') return `${NEON_ASH_BG} text-white border-b-2 border-indigo-700`;
                        if (element === 'bg-user') return `${NEON_USER_BG} text-white shadow-lg ${NEON_SHADOW}`;
                        if (element === 'bg-ash') return `${NEON_ASH_BG} text-indigo-300 border border-indigo-700/50 shadow-md shadow-gray-800/50`;
                        if (element === 'bg-chat-card') return NEON_ASH_BG;
                        if (element === 'btn-primary') return `${NEON_USER_BG} hover:opacity-80 text-white shadow-lg ${NEON_SHADOW}`;
                        if (element === 'btn-secondary') return `bg-gray-700 hover:opacity-80 text-white`;
                        return '';
                    case 'dark': // Default
                    default:
                        if (element === 'bg-main') return 'bg-gray-900 text-white';
                        if (element === 'bg-app') return bgAppClass;
                        if (element === 'bg-sidebar') return 'bg-gray-900/90 border-r border-gray-800 text-white';
                        if (element === 'bg-header') return 'bg-gray-900/90 shadow-md';
                        if (element === 'bg-modal') return 'bg-gray-900/90'; 
                        if (element === 'text-primary') return 'text-indigo-500';
                        if (element === 'bg-input') return 'bg-gray-700 text-white border-gray-600';
                        if (element === 'bg-user') return 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30';
                        if (element === 'bg-ash') return 'bg-gray-800 text-gray-200 border border-gray-700 shadow-md shadow-gray-800/50';
                        if (element === 'bg-chat-card') return 'bg-gray-800';
                        if (element === 'btn-primary') return 'bg-indigo-500 hover:bg-indigo-600 text-white';
                        if (element === 'btn-secondary') return 'bg-gray-700 hover:bg-gray-600 text-white';
                        return '';
                }
            };


            // 1. INITIALISATION FIREBASE & LOCAL STORAGE
            useEffect(() => {
                // R√©cup√©ration des pr√©f√©rences locales
                const storedNickname = localStorage.getItem('ashia_nickname');
                const storedLanguage = localStorage.getItem('ashia_lang');
                const storedTheme = localStorage.getItem('ashia_theme');
                const storedUserType = localStorage.getItem('ashia_usertype');

                if (storedNickname) {
                     setNickname(storedNickname);
                     setIsNicknameModalOpen(false); 
                } else {
                     setIsNicknameModalOpen(true);
                }

                if (storedLanguage) setLanguage(storedLanguage);
                if (storedTheme) setTheme(storedTheme);
                if (storedUserType) setUserType(storedUserType);
                
                // --- Initialisation Firebase ---
                if (typeof window.firebase === 'undefined') {
                    console.error("Firebase SDK not loaded.");
                    return;
                }
                
                try {
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    const app = window.firebase.initializeApp(firebaseConfig);
                    const dbInstance = window.firebase.getFirestore(app);
                    const authInstance = window.firebase.getAuth(app);
                    
                    setDb(dbInstance);
                    setAuth(authInstance);

                    // Authentification
                    window.firebase.onAuthStateChanged(authInstance, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                            console.log("Firebase Auth Ready. User ID:", user.uid);
                        } else {
                            // Si l'utilisateur n'est pas authentifi√©, se connecter.
                            try {
                                if (typeof __initial_auth_token !== 'undefined') {
                                    await window.firebase.signInWithCustomToken(authInstance, __initial_auth_token);
                                } else {
                                    await window.firebase.signInAnonymously(authInstance);
                                }
                                // La fonction onAuthStateChanged se d√©clenchera √† nouveau avec l'utilisateur
                            } catch (e) {
                                console.error("Firebase Sign-In Error:", e);
                                setIsAuthReady(true); // Marquer comme pr√™t m√™me en cas d'erreur
                            }
                        }
                    });

                } catch (e) {
                    console.error("Firebase Initialization Failed:", e);
                    setIsAuthReady(true);
                }

            }, []);

            // 2. Auto-scroll effect
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            // 3. √âCOUTE EN TEMPS R√âEL DES CONVERSATIONS (onSnapshot)
            useEffect(() => {
                 if (!db || !userId) return;

                 const q = window.firebase.query(
                     getChatCollectionRef(db, userId),
                     window.firebase.orderBy('lastUpdated', 'desc'),
                     window.firebase.limit(50)
                 );

                 // Attache le listener en temps r√©el
                 const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                     const fetchedChats = snapshot.docs.map(doc => ({
                         id: doc.id,
                         ...doc.data(),
                         // Convertir le timestamp si n√©cessaire
                         lastUpdated: doc.data().lastUpdated?.toDate ? doc.data().lastUpdated.toDate() : doc.data().lastUpdated,
                         createdAt: doc.data().createdAt?.toDate ? doc.data().createdAt.toDate() : doc.data().createdAt,
                     }));
                     
                     setChats(fetchedChats);
                     console.log(`Fetched ${fetchedChats.length} chats.`);

                     // Si c'est la premi√®re fois qu'on charge et qu'il y a des chats, charger le plus r√©cent.
                     if (currentChatId === null && fetchedChats.length > 0) {
                          // Charger le chat le plus r√©cent
                          loadChat(fetchedChats[0]);
                          console.log("Auto-loaded latest chat.");
                     }
                 }, (error) => {
                     console.error("Firestore snapshot error:", error);
                 });

                 // D√©tache le listener lorsque le composant est d√©mont√© ou que les d√©pendances changent
                 return () => unsubscribe();
            }, [db, userId]); // D√©pend de db et userId


            // --- FILE HANDLERS ---
            
            const handleFileSelect = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // Simple validation pour ne prendre que les images (Gemini supporte majoritairement les images en Base64)
                if (!file.type.startsWith('image/')) {
                    console.error("Seules les images sont support√©es pour l'upload (via Base64).");
                    // Nettoyer l'input pour permettre le re-upload
                    fileInputRef.current.value = null; 
                    return;
                }
                
                try {
                    const base64 = await fileToBase64(file);
                    setUploadedImage({ 
                        base64: base64, 
                        mimeType: file.type, 
                        name: file.name 
                    });
                    
                    // Nettoyer l'input pour pouvoir s√©lectionner le m√™me fichier √† nouveau si l'utilisateur annule et recommence
                    fileInputRef.current.value = null; 
                    
                } catch (error) {
                    console.error("Erreur lors de la conversion en Base64:", error);
                }
            };

            const removeUploadedImage = () => {
                setUploadedImage(null);
            };

            // --- CHAT MANAGEMENT FUNCTIONS (avec persistance) ---
            
            // Revenir √† un √©tat de chat vide (non sauvegard√© tant qu'il n'y a pas de message)
            const newChat = (type = 'standard') => {
                setMessages([]);
                setCurrentChatId(null);
                setChatType(type); 
                setIsMenuOpen(false); 
                setIsNewChatMenuOpen(false);
                setInput('');
                setUploadedImage(null); // IMPORTANT: Vider l'image en cours
            };
            
            const startNewStandardChat = () => newChat('standard'); 
            const startNewEphemeralChat = () => newChat('ephemeral'); 

            // Sauvegarde ou mise √† jour de la conversation
            const saveChat = async (currentMessages, chatId = currentChatId) => {
                if (!db || !userId || chatType === 'ephemeral' || currentMessages.length === 0) return;

                try {
                    const chatData = {
                        messages: currentMessages,
                        lastUpdated: window.firebase.serverTimestamp(),
                        preview: currentMessages[0].text.substring(0, 100),
                        role: userType || 'general'
                    };

                    if (chatId) {
                        // Mise √† jour du document existant
                        const chatRef = window.firebase.doc(getChatCollectionRef(db, userId), chatId);
                        await window.firebase.updateDoc(chatRef, chatData);
                    } else {
                        // Cr√©ation d'un nouveau document pour le premier message
                        const userFirstText = currentMessages[0].text || currentMessages[0].parts.find(p => p.text)?.text || 'Nouveau Chat';
                        const newDocRef = await window.firebase.addDoc(getChatCollectionRef(db, userId), {
                            ...chatData,
                            createdAt: window.firebase.serverTimestamp(),
                            // Le titre est la premi√®re phrase de l'utilisateur
                            title: userFirstText.substring(0, 30) + (userFirstText.length > 30 ? '...' : ''),
                        });
                        setCurrentChatId(newDocRef.id);
                        console.log("Nouveau chat cr√©√© et sauvegard√©:", newDocRef.id);
                    }
                } catch (error) {
                    console.error("Erreur lors de la sauvegarde du chat:", error);
                }
            };

            const loadChat = (chat) => {
                // S'assurer que les messages sont correctement d√©s√©rialis√©s (Firestore stocke les tableaux)
                setMessages(chat.messages || []);
                setCurrentChatId(chat.id);
                setChatType('standard');
                setIsMenuOpen(false); // Fermer la sidebar
                setUploadedImage(null); // Vider l'image au chargement d'un nouveau chat
                console.log("Chat charg√©:", chat.id);
            };

            const deleteChat = async (id) => {
                 if (!db || !userId || !window.confirm(t.chatDeleteConfirm)) return;
                 try {
                     const chatRef = window.firebase.doc(getChatCollectionRef(db, userId), id);
                     await window.firebase.deleteDoc(chatRef);
                     
                     // Si c'est le chat actif, d√©marrer un nouveau chat
                     if (currentChatId === id) {
                         newChat('standard');
                     }
                     
                     console.log("Chat deleted:", id);
                 } catch (error) {
                     console.error("Error deleting chat:", error);
                 }
            };

            const updateChatTitle = async (id, newTitle) => {
                 if (!db || !userId) return;
                 try {
                     const chatRef = window.firebase.doc(getChatCollectionRef(db, userId), id);
                     await window.firebase.updateDoc(chatRef, { title: newTitle });
                     console.log("Chat title updated:", id);
                 } catch (error) {
                     console.error("Error updating chat title:", error);
                 } finally {
                     setIsTitleEditModalOpen(false);
                     setChatToEdit(null);
                 }
            }


            const getSystemInstruction = (type) => {
                 const langCode = language === 'fr' ? 'fran√ßais' : 'english';
                 // INSTRUCTION MODIFI√âE: Supprime l'autorisation du gras Markdown (**texte**)
                 const baseInstruction = `You are Ash.ia, a helpful AI assistant. Respond in ${langCode}. Your responses MUST be EXTREMELY BRIEF and direct. Use the LaTeX syntax ($$...$$ for block, $...$ for inline) for all mathematical formulas and scientific notation, like $\sum_{i=1}^{n} i^2$. DO NOT use any other Markdown (bolding, lists, titles, blockquotes, code blocks). ALWAYS end every response with one relevant follow-up question.`;

                 if (type === 'student') {
                     return `${baseInstruction} Act as an academic tutor. Focus on essential and pedagogical information.`;
                 }
                 if (type === 'professional') {
                     return `${baseInstruction} Act as a professional and strategic consultant. Focus on executive summaries and key recommendations.`;
                 }
                 return `${baseInstruction} Act as a general knowledgeable assistant.`; 
            };

            const callGeminiApi = async (messages, userPrompt, imagePart = null, attempt = 1) => {
                 // ** VALIDER SI LA CL√â EST VALIDE AVANT L'APPEL **
                 const VALID_KEY_LENGTH = 39;
                 if (API_KEY.length < VALID_KEY_LENGTH) {
                     console.error(t.keyError(API_KEY.length));
                     return { text: t.keyError(API_KEY.length), sources: [] };
                 }

                 const systemPrompt = getSystemInstruction(userType); 
                
                 // Pr√©paration de l'historique pour l'API
                 let chatHistory = messages.map(msg => ({
                     role: msg.role === 'user' ? 'user' : 'model', 
                     parts: msg.parts // Utiliser msg.parts pour les messages utilisateur avec image
                 }));

                 const payload = {
                     contents: chatHistory, 
                     tools: [{ "google_search": {} }],
                     systemInstruction: { parts: [{ text: systemPrompt }] },
                 };
                
                 // AJOUT DE D√âBOGAGE
                 console.log("Tentative d'appel √† l'API Gemini...", { attempt, model: MODEL_NAME, url: API_URL });

                 try {
                     const response = await fetch(API_URL, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(payload)
                     });

                     if (!response.ok) {
                         // Erreur 429: Trop de requ√™tes
                         if (response.status === 429 && attempt < MAX_RETRIES) {
                             const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                             await new Promise(resolve => setTimeout(resolve, delay));
                             return callGeminiApi(messages, userPrompt, imagePart, attempt + 1);
                         }
                         
                         // Erreur 403: Acc√®s refus√© (tr√®s probable restriction de cl√©)
                         if (response.status === 403) {
                             const errorText = await response.text();
                             console.error(`API Error 403 (Forbidden):`, errorText);
                             return { text: t.apiRestrictionError, sources: [] };
                         }

                         const errorText = await response.text();
                         throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
                     }

                     const result = await response.json();
                     const candidate = result.candidates?.[0];

                     if (candidate && candidate.content?.parts?.[0]?.text) {
                         const text = candidate.content.parts[0].text;
                         let sources = [];
                         const groundingMetadata = candidate.groundingMetadata;

                         if (groundingMetadata && groundingMetadata.groundingAttributions) {
                             sources = groundingMetadata.groundingAttributions
                                 .map(attribution => ({
                                     uri: attribution.web?.uri,
                                     title: attribution.web?.title,
                                 }))
                                 .filter(source => source.uri && source.title);
                         }
                         console.log("API Success.");
                         return { text, sources };

                     } else {
                         return { text: t.apiError, sources: [] };
                     }

                 } catch (error) {
                     console.error("Erreur lors de l'appel √† l'API Gemini:", error);
                     if (attempt < MAX_RETRIES) {
                         const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                         await new Promise(resolve => setTimeout(resolve, delay));
                         return callGeminiApi(messages, userPrompt, imagePart, attempt + 1);
                     }
                     return { text: t.apiConnectionError, sources: [] };
                 }
            };

            const handleReformulate = async (originalMessage) => {
                if (isLoading) return;

                // Trouver le dernier message utilisateur pour re-envoyer le contexte
                const lastUserMessage = messages.slice().reverse().find(msg => msg.role === 'user');
                if (!lastUserMessage) {
                    console.error("No previous user message to reformulate.");
                    // Ajouter un message d'erreur √† l'utilisateur
                    setMessages([...messages, { role: 'assistant', text: "Je ne peux reformuler que la r√©ponse √† votre derni√®re question. Veuillez d'abord poser une question.", parts: [{ text: "Je ne peux reformuler que la r√©ponse √† votre derni√®re question. Veuillez d'abord poser une question." }] }]);
                    return;
                }

                // Le prompt d'instruction pour la reformulation
                const reformulationPrompt = `Reformulez le dernier message de l'assistant, en changeant son ton ou sa structure, bas√© sur la requ√™te pr√©c√©dente de l'utilisateur. Le message original √©tait: "${originalMessage.text}".`;
                
                // On pr√©pare le message utilisateur pour l'API qui inclut la demande de reformulation
                const reformulationMessage = { role: 'user', parts: [{ text: reformulationPrompt }], text: reformulationPrompt };

                // L'historique pour l'API sera: Historique normal + le message de reformulation
                const newMessages = [...messages, reformulationMessage];
                setMessages(newMessages); // Ajoute la demande de reformulation √† l'historique visible

                setIsLoading(true);

                try {
                    // On fait l'appel en se basant sur le contexte pr√©c√©dent
                    const { text, sources } = await callGeminiApi(newMessages, reformulationPrompt); 

                    // On ajoute la nouvelle r√©ponse au chat
                    const updatedMessages = [...newMessages, { role: 'assistant', parts: [{ text }], text, sources }];
                    setMessages(updatedMessages);
                    await saveChat(updatedMessages); // Sauvegarde automatique

                } catch (error) {
                    console.error("Erreur lors de la reformulation:", error);
                    const errorMessages = [...newMessages, { role: 'assistant', text: t.criticalError, parts: [{ text: t.criticalError }] }];
                    setMessages(errorMessages);
                } finally {
                    setIsLoading(false);
                }
            };


            const sendMessage = async (e) => {
                 e.preventDefault();
                 if (!input.trim() && !uploadedImage || isLoading) {
                     return;
                 }
                 
                 const VALID_KEY_LENGTH = 39;
                 if (API_KEY.length < VALID_KEY_LENGTH) {
                     setMessages([...messages, { role: 'assistant', text: t.keyError(API_KEY.length) }]);
                     return;
                 }


                 const userMessageText = input.trim() || uploadedImage?.name || 'Image envoy√©e';
                 setInput('');
                
                 // Construction des parties du message utilisateur
                 let userParts = [];
                 if (uploadedImage) {
                     userParts.push({ 
                         inlineData: {
                             mimeType: uploadedImage.mimeType,
                             data: uploadedImage.base64
                         } 
                     });
                 }
                 if (userMessageText) {
                     userParts.push({ text: userMessageText });
                 }
                 
                 const userMessage = { role: 'user', parts: userParts, text: userMessageText };
                 const newMessages = [...messages, userMessage];
                 setMessages(newMessages);
                 setUploadedImage(null); // IMPORTANT: Vider l'image apr√®s l'avoir ajout√©e aux messages
                 setIsLoading(true);

                 try {
                     const { text, sources } = await callGeminiApi(newMessages, userMessageText, uploadedImage); 

                     const updatedMessages = [...newMessages, { role: 'assistant', parts: [{ text }], text, sources }];
                     setMessages(updatedMessages);
                    
                     await saveChat(updatedMessages); // Sauvegarde automatique

                 } catch (error) {
                     console.error("Erreur principale de l'application:", error);
                     const errorMessages = [...newMessages, { role: 'assistant', text: t.criticalError, parts: [{ text: t.criticalError }] }];
                     setMessages(errorMessages);
                 } finally {
                     setIsLoading(false);
                 }
            };


            const resetAllSettings = () => {
                 if (window.confirm(t.resetConfirm)) {
                     setNickname('');
                     setUserType(null);
                     setMessages([]);
                     setCurrentChatId(null);
                     setChatType('standard'); 
                     setIsSettingsModalOpen(false); 
                     setIsNicknameModalOpen(true); 
                     localStorage.removeItem('ashia_nickname'); 
                     localStorage.removeItem('ashia_lang');
                     localStorage.removeItem('ashia_theme');
                     localStorage.removeItem('ashia_usertype');
                     // Note: Les donn√©es Firestore ne sont pas effac√©es ici pour des raisons de s√©curit√©
                 }
            };
            
            const handleSettingChange = (key, value) => {
                 switch (key) {
                     case 'userType':
                         setUserType(value);
                         if (value) {
                             localStorage.setItem('ashia_usertype', value);
                         } else {
                             localStorage.removeItem('ashia_usertype');
                         }
                         break;
                     case 'language':
                         setLanguage(value);
                         localStorage.setItem('ashia_lang', value);
                         break;
                     case 'theme':
                         setTheme(value);
                         localStorage.setItem('ashia_theme', value);
                         break;
                     default:
                         break;
                 }
            };
            
            // --- RENDER UTILITIES ---
            
            // Composant pour afficher les messages de l'assistant avec le formatage Markdown/LaTeX
            const FormattedMessageText = ({ text }) => {
                 if (!text) return null;

                 // Remplacement des sauts de ligne pour les paragraphes
                 let content = text.split('\n').map((line, lineIndex) => {
                     // 1. Remplacement des formules de bloc $$...$$ par un div
                     let parts = line.split(/(\$\$[\s\S]*?\$\$)/g).map((part, partIndex) => {
                         if (part.startsWith('$$') && part.endsWith('$$')) {
                             const mathContent = part.substring(2, part.length - 2).trim();
                             // Rendu brut du code LaTeX pour que l'utilisateur puisse le copier/coller dans un outil
                             return <div key={`${lineIndex}-m-${partIndex}`} className="math-block">{mathContent}</div>;
                         }
                         
                         // 2. Remplacement des formules en ligne $...$
                         let subParts = part.split(/(\$[\s\S]*?\$)/g).map((subPart, subPartIndex) => {
                              if (subPart.startsWith('$') && subPart.endsWith('$') && subPart.length > 1) {
                                  const inlineMathContent = subPart.substring(1, subPart.length - 1).trim();
                                  // Rendu brut du code LaTeX en ligne
                                  return <span key={`${lineIndex}-i-${subPartIndex}`} className="font-mono text-sm mx-0.5 whitespace-pre-wrap">{inlineMathContent}</span>;
                              }
                              
                              // Note: Suppression du remplacement du gras ici car l'IA ne doit plus l'utiliser
                              return subPart;
                         });

                         return <React.Fragment key={`${lineIndex}-p-${partIndex}`}>{subParts}</React.Fragment>;
                     });

                     // S'assurer qu'un saut de ligne simple donne un petit espace
                     return (
                         <p key={lineIndex} className={line.trim() === '' ? 'mt-1' : 'mt-2 first:mt-0 whitespace-pre-wrap'}>
                             {parts}
                         </p>
                     );
                 });
                
                 return <>{content}</>;
            };
            
            // Composant pour afficher une image envoy√©e dans le chat
            const ImagePartRenderer = ({ parts }) => {
                const imagePart = parts.find(p => p.inlineData && p.inlineData.mimeType.startsWith('image/'));
                if (!imagePart) return null;
                
                const imageUrl = `data:${imagePart.inlineData.mimeType};base64,${imagePart.inlineData.data}`;

                return (
                    <div className="mb-2 max-w-full rounded-lg overflow-hidden shadow-lg border border-gray-700">
                        <img 
                            src={imageUrl} 
                            alt="Image envoy√©e par l'utilisateur" 
                            className="w-full h-auto object-cover max-h-48" 
                            loading="lazy"
                        />
                    </div>
                );
            };

            // Composant de pr√©visualisation de l'image dans le footer
            const ImagePreview = () => {
                 if (!uploadedImage) return null;
                 const imageUrl = `data:${uploadedImage.mimeType};base64,${uploadedImage.base64}`;

                 return (
                     <div 
                         className={`absolute -top-32 left-0 right-0 p-3 flex items-center justify-between rounded-t-xl shadow-2xl ${getThemeClasses('bg-chat-card')} border-t border-indigo-700/50 cursor-pointer`}
                         onClick={removeUploadedImage}
                         title={t.imageUpload}
                     >
                         <div className="flex items-center space-x-3">
                             <img 
                                 src={imageUrl} 
                                 alt="Preview" 
                                 className="w-16 h-16 object-cover rounded-lg border-2 border-indigo-500"
                             />
                             <p className="text-sm font-semibold truncate max-w-[200px]">{t.imageUpload} ({uploadedImage.name || 'Image'})</p>
                         </div>
                         <button 
                             type="button" 
                             onClick={(e) => { e.stopPropagation(); removeUploadedImage(); }}
                             className={`p-1 rounded-full ${getThemeClasses('btn-secondary')} hover:bg-red-500/50`}
                             title={t.cancel}
                         >
                             <Icon name="X" className="w-5 h-5 text-red-400 icon-content" />
                         </button>
                     </div>
                 );
            };

            // --- RENDER MODALS (non modifi√©s) ---

            const NicknameModal = () => {
                 const [tempNickname, setTempNickname] = useState(''); 
                
                 useEffect(() => {
                     if (nickname) setTempNickname(nickname);
                 }, [nickname]);

                 const handleSaveNickname = () => {
                     if (!tempNickname.trim()) return;
                     setNickname(tempNickname.trim());
                     localStorage.setItem('ashia_nickname', tempNickname.trim()); 
                     setIsNicknameModalOpen(false);
                 };

                 const isFormValid = tempNickname.trim() && isAuthReady;

                 return (
                     <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 ${getThemeClasses('bg-main')} bg-opacity-95`}>
                         <div className={`w-full max-w-md p-6 rounded-xl shadow-2xl ${getThemeClasses('bg-modal')}`}>
                             <h2 className={`text-4xl font-bold mb-8 text-center ${getThemeClasses('text-primary')}`}>
                                 Ash.ia
                             </h2>

                             <div className="mb-6">
                                 <label className="block text-sm font-medium mb-2"></label>
                                 <input
                                     type="text"
                                     value={tempNickname}
                                     onChange={(e) => setTempNickname(e.target.value)}
                                     placeholder={t.nicknamePlaceholder} 
                                     className={`w-full p-3 rounded-lg outline-none ${getThemeClasses('bg-input')}`}
                                     onKeyDown={(e) => {
                                         if (e.key === 'Enter' && isFormValid) {
                                             handleSaveNickname();
                                         }
                                     }}
                                 />
                                 {!tempNickname.trim() && <p className="text-red-400 text-xs mt-2">{t.nicknameRequired}</p>}
                             </div>
                            
                             {/* Statut d'authentification */}
                             <div className="mt-4 mb-6 text-sm text-center text-gray-400">
                                 {isAuthReady ? t.authStatus : (
                                     <div className="flex items-center justify-center text-yellow-500">
                                         <Icon name="Loader" className="w-3 h-3 mr-1 animate-spin" />
                                         {t.authLoading}
                                     </div>
                                 )}
                             </div>

                             <button
                                 onClick={handleSaveNickname}
                                 className={`w-full p-3 font-bold rounded-xl transition duration-200 ${getThemeClasses('btn-primary')} ${!isFormValid ? 'opacity-50 cursor-not-allowed' : ''}`}
                                 disabled={!isFormValid}
                             >
                                 {t.continueButton}
                             </button>
                         </div>
                     </div>
                 );
            };

            const SettingsModal = () => {
                
                 const handleCloseSettings = () => {
                      setIsSettingsModalOpen(false);
                 };

                 if (!nickname) return null;

                 return (
                     <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 ${getThemeClasses('bg-main')} bg-opacity-95`}>
                         <div className={`w-full max-w-md p-6 rounded-xl shadow-2xl ${getThemeClasses('bg-modal')}`}>
                             <div className="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
                                 <h2 className={`text-2xl font-bold ${getThemeClasses('text-primary')}`}>
                                     <Icon name="Settings" className="inline w-6 h-6 mr-2 icon-content" /> {translations[language].settingsTitle}
                                 </h2>
                                  <button 
                                     onClick={handleCloseSettings} 
                                     className={`p-1 rounded-full transition duration-150 ${getThemeClasses('btn-secondary')}`}
                                     title={translations[language].close}
                                  >
                                     <Icon name="X" className="w-6 h-6 icon-content" />
                                  </button>
                             </div>

                             {/* SECTION 1: PROFIL D'INTERACTION - AUTO-SAVE */}
                             <div className={`mb-8 p-4 rounded-lg ${getThemeClasses('bg-chat-card')}`}>
                                 <label className="block text-lg font-semibold mb-4 text-white">{translations[language].profileLabel}</label>
                                 <div className="flex flex-wrap justify-center space-x-2 sm:space-x-4">
                                    
                                     {/* Option G√©n√©rale */}
                                     <button
                                         type="button"
                                         onClick={() => handleSettingChange('userType', null)}
                                         className={`flex-1 flex flex-col items-center p-3 font-semibold rounded-xl border-2 transition duration-200 min-w-[30%] mb-2 ${
                                             userType === null 
                                             ? `border-yellow-500 ring-2 ring-yellow-500 ${getThemeClasses('btn-primary').replace('bg-indigo', 'bg-yellow').replace('text-white', 'text-gray-900')}` 
                                             : `border-gray-500 ${getThemeClasses('btn-secondary')}`
                                         }`}
                                     >
                                         <Icon name="CheckCircle" className="w-6 h-6 mb-1 icon-content" /> <span>{translations[language].typeGeneral}</span>
                                     </button>
                                    
                                     {/* Option √âtudiant */}
                                     <button
                                         type="button"
                                         onClick={() => handleSettingChange('userType', 'student')}
                                         className={`flex-1 flex flex-col items-center p-3 font-semibold rounded-xl border-2 transition duration-200 min-w-[30%] mb-2 ${
                                             userType === 'student' 
                                             ? `border-blue-500 ring-2 ring-blue-500 ${getThemeClasses('btn-primary').replace('bg-indigo', 'bg-blue')}` 
                                             : `border-gray-500 ${getThemeClasses('btn-secondary')}`
                                         }`}
                                     >
                                         <Icon name="GraduationCap" className="w-6 h-6 mb-1 icon-content" /> <span>{translations[language].student}</span>
                                     </button>
                                    
                                     {/* Option Professionnel */}
                                     <button
                                         type="button"
                                         onClick={() => handleSettingChange('userType', 'professional')}
                                         className={`flex-1 flex flex-col items-center p-3 font-semibold rounded-xl border-2 transition duration-200 min-w-[30%] mb-2 ${
                                             userType === 'professional' 
                                             ? `border-teal-500 ring-2 ring-teal-500 ${getThemeClasses('btn-primary').replace('bg-indigo', 'bg-teal')}` 
                                             : `border-gray-500 ${getThemeClasses('btn-secondary')}`
                                         }`}
                                     >
                                         <Icon name="Briefcase" className="w-6 h-6 mb-1 icon-content" /> <span>{translations[language].professional}</span>
                                     </button>
                                 </div>
                             </div>
                            
                             {/* SECTION 2: LANGUE & TH√àME - AUTO-SAVE */}
                             <div className={`mb-8 p-4 rounded-lg ${getThemeClasses('bg-chat-card')}`}>
                                 <h3 className="block text-lg font-semibold mb-4 text-white">Interface</h3>
                                    
                                 {/* Choix de la Langue */}
                                 <div className="mb-5">
                                     <label className="block text-sm font-medium mb-2">{translations[language].language}</label>
                                     <div className="flex justify-around space-x-2">
                                         {['fr', 'en'].map((lang) => (
                                             <button
                                                 key={lang}
                                                 onClick={() => handleSettingChange('language', lang)}
                                                 className={`flex-1 p-3 rounded-xl border-2 font-semibold capitalize transition-all duration-200 ${
                                                     language === lang
                                                         ? `${getThemeClasses('btn-primary')}`
                                                         : `${getThemeClasses('btn-secondary')} opacity-70`
                                                 }`}
                                             >
                                                 <Icon name="Globe" className="w-4 h-4 mr-1 icon-content" />
                                                 {lang === 'fr' ? 'Fran√ßais' : 'English'}
                                             </button>
                                         ))}
                                     </div>
                                 </div>

                                 {/* Choix du Th√®me */}
                                 <div>
                                     <label className="block text-sm font-medium mb-2">{translations[language].themeLabel}</label>
                                     <div className="flex justify-around space-x-2">
                                         {['dark', 'light', 'neon'].map((t) => (
                                             <button
                                                 key={t}
                                                 onClick={() => handleSettingChange('theme', t)}
                                                 className={`flex-1 p-3 rounded-xl border-2 font-semibold capitalize transition-all duration-200 ${
                                                     theme === t
                                                         ? `${getThemeClasses('btn-primary')}`
                                                         : `${getThemeClasses('btn-secondary')} opacity-70`
                                                 }`}
                                             >
                                                 {t === 'dark' ? translations[language].darkMode : t === 'light' ? translations[language].lightMode : translations[language].neonMode}
                                             </button>
                                         ))}
                                     </div>
                                 </div>
                             </div>
                            
                             <button
                                 onClick={handleCloseSettings}
                                 className={`w-full p-3 font-bold rounded-xl transition duration-200 ${getThemeClasses('btn-primary')}`}
                             >
                                 {translations[language].close}
                             </button>

                             <button
                                 onClick={resetAllSettings}
                                 className="w-full mt-4 p-3 font-bold rounded-xl text-xs bg-red-800 hover:bg-red-700 text-white transition duration-200"
                             >
                                 <Icon name="Trash2" className="w-3 h-3 mr-1 icon-content" /> {translations[language].resetSettings} ({nickname})
                             </button>
                         </div>
                     </div>
                 );
            };

            const EditTitleModal = () => {
                 if (!chatToEdit) return null;
                 const [newTitle, setNewTitle] = useState(chatToEdit.title);

                 const handleUpdate = (e) => {
                     e.preventDefault();
                     if (newTitle.trim()) {
                         updateChatTitle(chatToEdit.id, newTitle.trim());
                     } else {
                         // G√©rer l'erreur si le titre est vide
                     }
                 };

                 return (
                     <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4">
                         <form onSubmit={handleUpdate} className={`w-full max-w-sm p-6 rounded-xl shadow-2xl ${getThemeClasses('bg-modal')}`}>
                             <h2 className={`text-xl font-bold mb-4 ${getThemeClasses('text-primary')}`}>
                                 <Icon name="Edit2" className="w-5 h-5 mr-2 icon-content" /> {t.renameChatTitle}
                             </h2>

                             <input
                                 type="text"
                                 value={newTitle}
                                 onChange={(e) => setNewTitle(e.target.value)}
                                 placeholder={t.newTitlePlaceholder}
                                 className={`w-full p-3 mb-4 rounded-lg outline-none ${getThemeClasses('bg-input')}`}
                                 maxLength={50}
                             />
                             <div className="flex justify-end space-x-3">
                                 <button
                                     type="button"
                                     onClick={() => {
                                         setIsTitleEditModalOpen(false);
                                         setChatToEdit(null); // IMPORTANT: R√©initialiser
                                     }}
                                     className={`p-2 px-4 rounded-lg font-semibold ${getThemeClasses('btn-secondary')}`}
                                 >
                                     {t.cancel}
                                 </button>
                                 <button
                                     type="submit"
                                     className={`p-2 px-4 rounded-lg font-semibold ${getThemeClasses('btn-primary')}`}
                                 >
                                     {t.save}
                                 </button>
                             </div>
                         </form>
                     </div>
                 );
            };


            const NewChatMenu = () => {
                 return (
                     <div className={`absolute top-14 right-0 z-30 w-56 p-2 rounded-xl shadow-2xl ${getThemeClasses('bg-modal')} flex flex-col space-y-2 border border-gray-700`}>
                         <button
                             onClick={startNewEphemeralChat}
                             className={`flex items-center p-3 rounded-lg text-sm font-semibold hover:opacity-80 transition duration-150 bg-gray-600 hover:bg-gray-500 text-white`}
                         >
                             <Icon name="Zap" className="w-5 h-5 mr-3 text-red-400 icon-content" /> {t.newEphemeral}
                         </button>
                         <button
                             onClick={startNewStandardChat}
                             className={`flex items-center p-3 rounded-lg text-sm font-semibold hover:opacity-80 transition duration-150 ${getThemeClasses('btn-primary')}`}
                         >
                             <Icon name="PlusCircle" className="w-5 h-5 mr-3 text-white icon-content" /> {t.newChat}
                         </button>
                         <button
                             onClick={startNewStandardChat} // Utiliser standard pour le projet, mais le nom change
                             className={`flex items-center p-3 rounded-lg text-sm font-semibold hover:opacity-80 transition duration-150 ${getThemeClasses('btn-primary').replace('bg-indigo', 'bg-teal')}`}
                             >
                             <Icon name="Bookmark" className="w-5 h-5 mr-3 text-white icon-content" /> {t.newProject}
                         </button>
                     </div>
                 );
            };

            // Bouton d'attachement de fichier (Maintenance lev√©e)
            const AttachmentButton = () => (
                 <button
                     type="button"
                     onClick={() => fileInputRef.current?.click()}
                     className={`p-3 rounded-full transition duration-150 shadow-md ${getThemeClasses('btn-secondary')} flex-shrink-0`}
                     title="Attacher une image ou un fichier"
                     disabled={isLoading || !isAuthReady}
                 >
                     <Icon name="Paperclip" className="w-6 h-6 icon-content" />
                 </button>
            );


            // --- RENDER SIDEBAR & CHAT SCREEN ---

            const renderSidebar = () => {
                 const getUserTypeLabel = (type) => {
                     switch (type) {
                         case 'student': return t.typeStudent;
                         case 'professional': return t.typeProfessional;
                         default: return t.typeGeneral;
                     }
                 };

                 return (
                     <div className={`fixed inset-y-0 left-0 z-20 w-80 ${getThemeClasses('bg-sidebar')} transform transition-transform duration-300 ease-in-out ${
                         isMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'
                     } flex flex-col p-4`}>
                        
                         <div className="flex justify-between items-center mb-6 pb-2 border-b border-gray-700">
                             <h2 className={`text-xl font-bold ${getThemeClasses('text-primary')}`}>{t.sidebarTitle}</h2>
                             <button 
                                 onClick={() => setIsMenuOpen(false)} 
                                 className={`p-2 rounded-full transition duration-150 ${getThemeClasses('btn-secondary')}`}
                             >
                                 <Icon name="X" className="w-6 h-6 icon-content" />
                             </button>
                         </div>
                        
                         {/* Nouveaux boutons de chat - En haut de la sidebar */}
                         <div className="flex flex-col space-y-2 mb-6">
                             <button
                                 onClick={startNewStandardChat}
                                 className={`flex items-center justify-center p-3 font-bold rounded-xl transition duration-200 ${getThemeClasses('btn-primary')}`}
                             >
                                 <Icon name="PlusCircle" className="w-5 h-5 mr-2 icon-content" /> {t.newChat}
                             </button>
                         </div>

                         <h3 className="text-sm font-semibold text-gray-400 mb-3 border-b border-gray-700 pb-1">{t.persistedChat}</h3>

                         <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar">
                             {chats.length > 0 ? chats.map((chat) => (
                                 <div 
                                     key={chat.id} 
                                     className={`flex items-center justify-between p-3 rounded-xl cursor-pointer transition duration-150 
                                         ${currentChatId === chat.id ? getThemeClasses('bg-user') : getThemeClasses('bg-chat-card')} 
                                         hover:opacity-80`}
                                     onClick={() => loadChat(chat)}
                                 >
                                     <div className="flex flex-col overflow-hidden">
                                         <span className="font-semibold truncate text-sm">{chat.title}</span>
                                         <span className="text-xs text-gray-400 truncate mt-0.5">{chat.preview}</span>
                                     </div>
                                     <div className="flex space-x-2 flex-shrink-0">
                                          <button 
                                             onClick={(e) => { 
                                                 e.stopPropagation(); 
                                                 setChatToEdit(chat); 
                                                 setIsTitleEditModalOpen(true); 
                                             }}
                                             className={`p-1 rounded-full hover:bg-gray-600/50 transition`}
                                             title={t.renameChatTitle}
                                         >
                                             <Icon name="Edit2" className="w-4 h-4 text-gray-400 icon-content" />
                                          </button>
                                          <button 
                                             onClick={(e) => { 
                                                 e.stopPropagation(); 
                                                 deleteChat(chat.id); 
                                             }}
                                             className={`p-1 rounded-full hover:bg-red-500/50 transition`}
                                             title={t.deleteChat}
                                         >
                                             <Icon name="Trash2" className="w-4 h-4 text-red-400 icon-content" />
                                          </button>
                                     </div>
                                 </div>
                             )) : (
                                <p className="text-gray-400 text-center mt-6">{t.noSavedChats}</p>
                             )}
                         </div>
                        
                         {/* Affichage de l'ID utilisateur pour le d√©bogage/partage */}
                         {userId && (
                             <div className={`mt-4 pt-2 border-t border-gray-700 text-xs text-gray-500 break-words`}>
                                 <p className='font-semibold'>ID Utilisateur :</p>
                                 <p className='mt-1'>{userId}</p>
                             </div>
                         )}
                     </div>
                 );
            };

            const renderChatScreen = () => {
                 const showWelcomeMessage = messages.length === 0 && !isLoading;
                
                 const chatTypeIndicator = currentChatId ? (
                     <span className="text-sm text-gray-400 truncate max-w-[200px]">{chats.find(c => c.id === currentChatId)?.title || t.newChat}</span>
                 ) : (
                      <span className="text-sm text-gray-400">{chatType === 'ephemeral' ? t.newEphemeral : t.newChat}</span>
                 );

                 return (
                     <div className={`flex flex-col h-full relative ${getThemeClasses('bg-main')}`}>
                        
                         {/* Modales toujours au-dessus */}
                         {isNicknameModalOpen && <NicknameModal />}
                         {isSettingsModalOpen && <SettingsModal />}
                         {isTitleEditModalOpen && <EditTitleModal />}
                         
                         {/* Overlay pour fermer le menu */}
                         {isMenuOpen && (
                             <div className="fixed inset-0 z-10 bg-black/50" onClick={() => setIsMenuOpen(false)}></div>
                         )}
                         {isNewChatMenuOpen && (
                             <div className="fixed inset-0 z-20" onClick={() => setIsNewChatMenuOpen(false)}></div>
                         )}
                        
                         {/* Ent√™te du chat (FIXE EN HAUT) */}
                         <header className={`fixed top-0 left-0 right-0 z-30 flex items-center justify-between p-4 ${getThemeClasses('bg-header')} flex-shrink-0`}>
                            
                             <div className="flex items-center space-x-3">
                                 <button
                                     onClick={() => setIsMenuOpen(true)}
                                     className={`p-2 rounded-full transition duration-150 ${getThemeClasses('btn-secondary')}`}
                                     title={t.openHistory}
                                 >
                                     <Icon name="Menu" className="w-6 h-6 icon-content" />
                                 </button>
                             </div>

                             {/* Titre Centr√© */}
                             <div className="flex flex-col items-center absolute left-1/2 transform -translate-x-1/2">
                                 <h1 className="text-2xl font-bold">Ash.ia</h1> 
                                 {chatTypeIndicator}
                             </div>

                             {/* Groupe de boutons Droite : Param√®tres et Nouveau Chat (Menu) */}
                             <div className="flex items-center space-x-3 relative">
                                 <button
                                     onClick={() => setIsSettingsModalOpen(true)}
                                     className={`p-2 rounded-full transition duration-150 ${getThemeClasses('btn-secondary')}`}
                                     title={t.settings}
                                 >
                                     <Icon name="Settings" className="w-6 h-6 icon-content" />
                                 </button>
                                 <button
                                     onClick={() => setIsNewChatMenuOpen(prev => !prev)}
                                     className={`p-2 rounded-full transition duration-150 shadow-md ${getThemeClasses('btn-primary')}`}
                                     title={t.startNewChat}
                                 >
                                     {isNewChatMenuOpen ? <Icon name="X" className="w-6 h-6 icon-content" /> : <Icon name="PlusCircle" className="w-6 h-6 icon-content" />}
                                 </button>
                                 {isNewChatMenuOpen && <NewChatMenu />}
                             </div>
                         </header>

                         {/* Zone de messages (D√âMARRE APR√àS L'ENT√äTE, MODIFI√âE AVEC pb-20) */}
                         <main className={`flex-1 overflow-y-auto p-4 space-y-8 ${getThemeClasses('bg-main')} custom-scrollbar pt-16 pb-20`}>
                            
                             {/* Message de bienvenue centr√© */}
                             {showWelcomeMessage && (
                                 <div className="absolute inset-0 flex flex-col items-center justify-center p-4 pointer-events-none" style={{ top: '64px', bottom: '64px' }}>
                                     <p className="text-xl font-semibold text-center text-gray-400 transition-opacity duration-300"
                                         style={{ opacity: showWelcomeMessage ? 1 : 0 }}
                                     >
                                         {t.welcomeMessage(nickname)}
                                     </p>
                                      {userType ? (
                                         <p className="text-sm mt-2 text-gray-500">
                                             {t.profileSelected(userType === 'student' ? t.typeStudent : t.typeProfessional)}
                                         </p>
                                     ) : (
                                         <p className="text-sm mt-2 text-gray-500">
                                             {t.profileGeneral}
                                         </p>
                                     )}
                                     {API_KEY.length < 39 && (
                                         <p className="text-sm mt-4 text-red-500 font-bold">
                                             üö® {t.keyError(API_KEY.length)} üö®
                                         </p>
                                     )}
                                 </div>
                             )}

                             {messages.map((msg, index) => (
                                 <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                     <div className={`max-w-[85%] p-3 rounded-xl relative ${ // Ajout de 'relative' pour positionner les boutons
                                         msg.role === 'user' 
                                         ? getThemeClasses('bg-user') + ' rounded-br-none'
                                         : getThemeClasses('bg-ash') + ' rounded-tl-none'
                                     }`}>
                                         {/* Affichage de l'image si pr√©sente dans le message utilisateur */}
                                         {msg.role === 'user' && msg.parts && <ImagePartRenderer parts={msg.parts} />}
                                        
                                         {/* Affichage du texte format√© */}
                                         <FormattedMessageText text={msg.text} />
                                        
                                         {/* Affichage des sources pour l'assistant */}
                                         {msg.role === 'assistant' && msg.sources && msg.sources.length > 0 && (
                                             <div className={`mt-3 pt-2 border-t border-gray-700 text-xs ${getThemeClasses('bg-ash').includes('dark') ? 'text-gray-400' : 'text-gray-500'}`}>
                                                 <p className="mb-1 font-semibold">{t.sources}</p>
                                                 <ul className="space-y-1">
                                                     {msg.sources.map((source, idx) => (
                                                         <li key={idx}>
                                                             <a 
                                                                 href={source.uri} 
                                                                 target="_blank" 
                                                                 rel="noopener noreferrer" 
                                                                 className={`hover:${getThemeClasses('text-primary')} transition duration-150 flex items-center`}
                                                             >
                                                                 <Icon name="ExternalLink" className="w-3 h-3 mr-1 icon-content" />
                                                                 {source.title.length > 50 ? source.title.substring(0, 50) + '...' : source.title}
                                                             </a>
                                                         </li>
                                                     ))}
                                                 </ul>
                                             </div>
                                         )}
                                         
                                         {/* ACTION BUTTONS (Assistants only, bottom right) */}
                                         {msg.role === 'assistant' && (
                                              <div className="absolute bottom-[-10px] right-0 flex space-x-1">
                                                  {/* Bouton Copier */}
                                                  <button
                                                      onClick={() => copyToClipboard(msg.text)}
                                                      className={`p-1 text-xs rounded-full ${getThemeClasses('bg-ash')} text-gray-400 hover:text-white hover:bg-indigo-600 transition duration-150 shadow-md border border-gray-700`}
                                                      title={t.copyMessage}
                                                  >
                                                      <Icon name="Clipboard" className="w-3 h-3 icon-content" />
                                                  </button>
                                                  {/* Bouton Reformuler */}
                                                  <button
                                                      onClick={() => handleReformulate(msg)}
                                                      className={`p-1 text-xs rounded-full ${getThemeClasses('bg-ash')} text-gray-400 hover:text-white hover:bg-yellow-600 transition duration-150 shadow-md border border-gray-700`}
                                                      title={t.reformulateMessage}
                                                      disabled={isLoading}
                                                  >
                                                      <Icon name="RefreshCw" className="w-3 h-3 icon-content" />
                                                  </button>
                                              </div>
                                         )}
                                     </div>
                                 </div>
                             ))}

                             {/* Indicateur de chargement : Ash r√©fl√©chi */}
                             {isLoading && (
                                 <div className="flex justify-start">
                                     <div className={`max-w-xs p-3 rounded-xl ${getThemeClasses('bg-ash')} rounded-tl-none shadow-lg flex items-center`}>
                                         <Icon name="Loader" className={`w-4 h-4 mr-2 animate-spin ${getThemeClasses('text-primary')} icon-content`} />
                                         <span className="text-sm font-bold">{t.thinking}</span>
                                     </div>
                                 </div>
                             )}
                             <div ref={messagesEndRef} />
                             
                             {/* CORRECTION: Mention du cr√©ateur d√©plac√©e √† l'int√©rieur du main pour d√©filer */}
                             <div className="p-4 text-center text-xs text-gray-500 pt-8 pb-4">
                                 Cr√©√© par le CEO ASH-SHISHANI
                             </div>
                         </main>

                         {/* Formulaire de saisie (FIXE EN BAS) */}
                         <footer className={`fixed bottom-0 left-0 right-0 p-3 ${getThemeClasses('bg-header')} flex-shrink-0 z-30`}>
                             
                             {/* Pr√©visualisation de l'image (position absolue) */}
                             <ImagePreview />

                             <form onSubmit={sendMessage} className="flex items-center space-x-3">
                                 {/* Champ d'upload de fichier masqu√© */}
                                 <input
                                     type="file"
                                     ref={fileInputRef}
                                     onChange={handleFileSelect}
                                     accept="image/*"
                                     className="hidden"
                                 />

                                 {/* Bouton d'attachement (d√©clenche le click sur l'input masqu√©) */}
                                 <AttachmentButton />
                                 
                                 <input
                                     type="text"
                                     value={input}
                                     onChange={(e) => setInput(e.target.value)}
                                     placeholder={t.sendPlaceholder}
                                     className={`flex-1 p-3 rounded-full outline-none transition duration-150 placeholder-gray-400 ${getThemeClasses('bg-input')}`}
                                     disabled={isLoading || !isAuthReady}
                                 />
                                 <button
                                     type="submit"
                                     className={`p-3 rounded-full transition duration-150 shadow-xl ${getThemeClasses('btn-primary')} flex-shrink-0 ${
                                         (!input.trim() && !uploadedImage) || isLoading || !isAuthReady
                                         ? 'opacity-50 cursor-not-allowed'
                                         : 'transform active:scale-95'
                                     }`}
                                     disabled={(!input.trim() && !uploadedImage) || isLoading || !isAuthReady}
                                 >
                                     <Icon name="Send" className="w-6 h-6 icon-content" />
                                 </button>
                             </form>
                         </footer>
                        
                         {/* Sidebar */}
                         {renderSidebar()}
                     </div>
                 );
            };
            
            return (
                 <div className={`h-screen w-screen overflow-hidden ${getThemeClasses('bg-app')} ${theme === 'neon' ? 'neon-text-shadow' : ''}`}>
                      <CustomStyles />
                      {renderChatScreen()}
                 </div>
            );
        };
        
        // Rendu de l'application dans la balise div#root
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
