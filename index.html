<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ash.ia - Assistant IA</title>
    
    <!-- Chargement des biblioth√®ques React via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Chargement de Babel pour JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chargement de Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuration Tailwind pour utiliser la police Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Styles personnalis√©s pour le d√©filement */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }

        /* Styles suppl√©mentaires pour la visibilit√© des ic√¥nes/emojis */
        .icon-content {
            font-family: 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;
            display: inline-block;
        }
    </style>
    
</head>
<body class="p-0 m-0 overflow-hidden">

    <div id="root" class="h-screen w-screen">
        <!-- L'application React sera inject√©e ici -->
    </div>

    <!-- Le code React/JSX doit √™tre inclus dans un script de type 'text/babel' -->
    <script type="text/babel">
        // --------------------------------------------------------------------------------------------------
        // CODE REACT INTEGRAL DE L'APPLICATION ASH.IA
        // --------------------------------------------------------------------------------------------------
        
        const { useState, useEffect, useRef } = React;
        
        // --- SIMULATION D'IC√îNES LUCIDE-REACT ---
        const Icon = ({ name, className, children }) => {
            let IconContent;
            switch(name) {
                case 'Send': IconContent = '‚û§'; break;
                case 'CheckCircle': IconContent = '‚úÖ'; break;
                case 'GraduationCap': IconContent = 'üéì'; break;
                case 'Briefcase': IconContent = 'üíº'; break;
                case 'Loader': IconContent = '‚è≥'; break;
                case 'ExternalLink': IconContent = 'üîó'; break;
                case 'Menu': IconContent = '‚ò∞'; break;
                case 'X': IconContent = '‚úñ'; break;
                case 'Trash2': IconContent = 'üóëÔ∏è'; break;
                case 'PlusCircle': IconContent = '‚ûï'; break;
                case 'Settings': IconContent = '‚öôÔ∏è'; break;
                case 'Edit2': IconContent = '‚úé'; break;
                case 'Globe': IconContent = 'üåê'; break;
                case 'Bookmark': IconContent = 'üîñ'; break;
                case 'Zap': IconContent = '‚ö°'; break;
                default: IconContent = name;
            }
            return <span className={`inline-block icon-content ${className}`}>{IconContent}{children}</span>;
        };
        
        // --- CONFIGURATION DE BASE CRITIQUE API ---
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        
        // CL√â API: VEUILLEZ REMPLACER CETTE CHA√éNE PAR VOTRE CL√â API COMPL√àTE
        // Note: L'ancienne cl√© √©tait trop courte (39 chars) et causait une erreur personnalis√©e. 
        // Cette cl√© placeholder a 51 caract√®res pour passer la v√©rification de longueur.
        const API_KEY = "AIzaSyCDg-WPAJhx-DKbvhqbVbY2eAGwk6nSSk0"; 
        
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 3;

        // Helper to format source links
        const formatSource = (source) => {
            if (source.uri && source.title) {
                return `[${source.title}](${source.uri})`;
            }
            return '';
        };

        // --- TRADUCTIONS DE L'INTERFACE UTILISATEUR ---
        const translations = {
            fr: {
                nicknamePlaceholder: "Votre pseudo (Ex: UserX)",
                profileLabel: "Profil d'Interaction (Optionnel)",
                student: "√âtudiant",
                professional: "Professionnel",
                themeLabel: "Th√®me de l'Application",
                darkMode: "Sombre",
                lightMode: "Clair",
                neonMode: "N√©on Bleu Nuit",
                settingsTitle: "Param√®tres de l'Application",
                continueButton: "Continuer",
                startButton: "Commencer le Chat",
                authStatus: "Authentification OK",
                authLoading: "Chargement de l'authentification...",
                sidebarTitle: "Historique",
                newChat: "Nouveau Chat",
                newProject: "Cr√©er un Projet",
                newEphemeral: "Chat √âph√©m√®re (Non Sauvegard√©)",
                noSavedChats: "Aucun chat sauvegard√©.",
                typeStudent: "√âtudiant",
                typeProfessional: "Professionnel",
                typeGeneral: "G√©n√©ral",
                renameChatTitle: "Renommer le Chat",
                newTitlePlaceholder: "Nouveau titre du chat",
                cancel: "Annuler",
                close: "Fermer", 
                save: "Sauvegarder", 
                openHistory: "Ouvrir l'historique",
                settings: "Param√®tres",
                startNewChat: "D√©marrer un Nouveau Chat",
                welcomeMessage: (pseudo) => `Bienvenue ${pseudo}, posez-moi une question !`,
                profileSelected: (userTypeLabel) => `Votre profil ${userTypeLabel} est s√©lectionn√©. Posez votre premi√®re question pour d√©marrer un chat.`,
                profileGeneral: "Aucun profil s√©lectionn√©. Vous √™tes en mode G√©n√©ral.",
                useMenu: "Utilisez le menu pour charger vos conversations.",
                sendPlaceholder: "Envoyer un message √† Ash.ia...",
                thinking: ".... Ash r√©fl√©chi", 
                sources: "Sources:",
                criticalError: "Une erreur critique est survenue.",
                apiError: "Ash.ia a rencontr√© une difficult√© pour g√©n√©rer une r√©ponse. Que d√©sirez-vous savoir d'autre ?",
                apiConnectionError: "Ash.ia n'a pas pu se connecter pour le moment. Veuillez r√©essayer. Quel sujet voulez-vous aborder ?",
                language: "Langue de l'Interface",
                resetSettings: "R√©initialiser le Profil & Pseudo",
                resetConfirm: "R√©initialiser le pseudo et le profil ?",
                nicknameRequired: "Veuillez entrer un pseudo.",
                deleteChat: "Supprimer le Chat",
                keyError: (length) => `ERREUR API: La cl√© API est trop courte ou invalide. Longueur actuelle: ${length}. Une cl√© compl√®te est n√©cessaire.`,
            },
            en: {
                nicknamePlaceholder: "Your Nickname (Ex: UserX)",
                profileLabel: "Interaction Profile (Optional)",
                student: "Student",
                professional: "Professional",
                themeLabel: "Application Theme",
                darkMode: "Dark",
                lightMode: "Light",
                neonMode: "Neon Blue Night",
                settingsTitle: "Application Settings",
                continueButton: "Continue",
                startButton: "Start Chat",
                authStatus: "Authentication OK",
                authLoading: "Authentication loading...",
                sidebarTitle: "History",
                newChat: "New Chat",
                newProject: "Create Project",
                newEphemeral: "Ephemeral Chat (Not Saved)",
                noSavedChats: "No saved chats.",
                typeStudent: "Student",
                typeProfessional: "Professional",
                typeGeneral: "General",
                renameChatTitle: "Rename Chat",
                newTitlePlaceholder: "New chat title",
                cancel: "Cancel",
                close: "Close", 
                save: "Save", 
                openHistory: "Open History",
                settings: "Settings",
                startNewChat: "Start New Chat",
                welcomeMessage: (pseudo) => `Welcome ${pseudo}, ask me a question!`,
                profileSelected: (userTypeLabel) => `Your ${userTypeLabel} profile is selected. Ask your first question to start a chat.`,
                profileGeneral: "No profile selected. You are in General mode.",
                useMenu: "Use the menu to load your conversations.",
                sendPlaceholder: "Send a message to Ash.ia...",
                thinking: ".... Ash is thinking", 
                sources: "Sources:",
                criticalError: "A critical error occurred.",
                apiError: "Ash.ia encountered a difficulty generating a response. What else would you like to know?",
                apiConnectionError: "Ash.ia could not connect at this time. Please try again. What topic do you want to discuss?",
                language: "Interface Language",
                resetSettings: "Reset Profile & Nickname",
                resetConfirm: "Reset nickname and profile?",
                nicknameRequired: "Please enter a nickname.",
                deleteChat: "Delete Chat",
                keyError: (length) => `API ERROR: The API key is too short or invalid. Current length: ${length}. A complete key is required.`,
            }
        };


        // --- COMPOSANT PRINCIPAL DE L'APPLICATION ---
        const App = () => {
            // UI States
            const [language, setLanguage] = useState('fr'); 
            const t = translations[language]; 
            
            // userType peut √™tre null (mode G√©n√©ral)
            const [userType, setUserType] = useState(null); 
            const [theme, setTheme] = useState('dark'); 
            const [nickname, setNickname] = useState(''); 
            const [isMenuOpen, setIsMenuOpen] = useState(false); // Sidebar
            const [isNewChatMenuOpen, setIsNewChatMenuOpen] = useState(false); // Menu + button
            
            // Gestion des modales
            const [isNicknameModalOpen, setIsNicknameModalOpen] = useState(true); 
            const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false); 

            // Chat States
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [currentChatId, setCurrentChatId] = useState(null);
            const [chats, setChats] = useState([]); 
            const [chatType, setChatType] = useState('ephemeral'); // Forcer en √©ph√©m√®re

            // States for title editing (non-fonctionnel sans persistance, mais gard√©)
            const [isTitleEditModalOpen, setIsTitleEditModalOpen] = useState(false);
            const [chatToEdit, setChatToEdit] = useState(null);

            // Firebase States (simplifi√©s/d√©sactiv√©s)
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            
            const messagesEndRef = useRef(null);
            
            const isTyping = input.length > 0;

            // --- LOGIQUE DE TH√àME ET STYLES ---

            const CustomStyles = () => (
                <style>{`
                    /* Ombre de texte pour la nuance de couleur des caract√®res (plus joli) */
                    .neon-text-shadow {
                         /* Subtile ombre blanche/indigo pour l'effet 'n√©on' l√©ger */
                         text-shadow: 0 0 1px rgba(255, 255, 255, 0.1), 0 0 4px rgba(129, 140, 248, 0.2); 
                    }
                    
                    /* Correction de la police pour les ic√¥nes remplac√©es par des emojis */
                    .icon-content {
                        font-family: 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;
                        display: inline-block;
                    }
                `}</style>
            );

            const getThemeClasses = (element) => {
                const bgAppClass = 'bg-gray-950';

                switch (theme) {
                    case 'light':
                        if (element === 'bg-main') return 'bg-gray-100 text-gray-800'; 
                        if (element === 'bg-app') return bgAppClass; 
                        if (element === 'bg-sidebar') return 'bg-white border-r border-gray-200 text-gray-800';
                        if (element === 'bg-header') return 'bg-white shadow-lg';
                        if (element === 'bg-modal') return 'bg-white'; 
                        if (element === 'text-primary') return 'text-indigo-600';
                        if (element === 'bg-input') return 'bg-gray-200 text-gray-800 border-gray-300';
                        if (element === 'bg-user') return 'bg-blue-600 text-white shadow-lg shadow-blue-500/30';
                        if (element === 'bg-ash') return 'bg-white text-gray-900 border border-gray-200 shadow-md';
                        if (element === 'bg-chat-card') return 'bg-gray-200'; 
                        if (element === 'btn-primary') return 'bg-indigo-600 hover:bg-indigo-700 text-white';
                        if (element === 'btn-secondary') return 'bg-gray-300 hover:bg-gray-400 text-gray-800';
                        return '';
                    case 'neon': 
                        const NEON_BG = 'bg-[#0A0A2A]'; // Bleu Nuit
                        const NEON_USER_BG = 'bg-indigo-700'; // Fond message utilisateur
                        const NEON_ASH_BG = 'bg-gray-800'; // Fond message ASH
                        const NEON_SHADOW = 'shadow-indigo-500/30';

                        if (element === 'bg-main') return `${NEON_BG} text-gray-50`;
                        if (element === 'bg-app') return NEON_BG;
                        if (element === 'bg-sidebar') return `${NEON_BG} border-r border-indigo-800 text-gray-50`;
                        if (element === 'bg-header') return `${NEON_BG} shadow-xl`;
                        if (element === 'bg-modal') return `${NEON_BG}/95`; 
                        if (element === 'text-primary') return 'text-indigo-400';
                        if (element === 'bg-input') return `${NEON_ASH_BG} text-white border-b-2 border-indigo-700`;
                        if (element === 'bg-user') return `${NEON_USER_BG} text-white shadow-lg ${NEON_SHADOW}`;
                        if (element === 'bg-ash') return `${NEON_ASH_BG} text-indigo-300 border border-indigo-700/50 shadow-md shadow-gray-800/50`;
                        if (element === 'bg-chat-card') return NEON_ASH_BG;
                        if (element === 'btn-primary') return `${NEON_USER_BG} hover:opacity-80 text-white shadow-lg ${NEON_SHADOW}`;
                        if (element === 'btn-secondary') return `bg-gray-700 hover:opacity-80 text-white`;
                        return '';
                    case 'dark': // Default
                    default:
                        if (element === 'bg-main') return 'bg-gray-900 text-white';
                        if (element === 'bg-app') return bgAppClass;
                        if (element === 'bg-sidebar') return 'bg-gray-900/90 border-r border-gray-800 text-white';
                        if (element === 'bg-header') return 'bg-gray-900/90 shadow-md';
                        if (element === 'bg-modal') return 'bg-gray-900/90'; 
                        if (element === 'text-primary') return 'text-indigo-500';
                        if (element === 'bg-input') return 'bg-gray-700 text-white border-gray-600';
                        if (element === 'bg-user') return 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/30';
                        if (element === 'bg-ash') return 'bg-gray-800 text-gray-200 border border-gray-700 shadow-md shadow-gray-800/50';
                        if (element === 'bg-chat-card') return 'bg-gray-800';
                        if (element === 'btn-primary') return 'bg-indigo-500 hover:bg-indigo-600 text-white';
                        if (element === 'btn-secondary') return 'bg-gray-700 hover:bg-gray-600 text-white';
                        return '';
                }
            };


            // 1. INITIALISATION DE BASE (LOCAL STORAGE & AUTH ID)
            useEffect(() => {
                // Initialisation de l'ID utilisateur anonyme et marquage de l'√©tat pr√™t
                setUserId(crypto.randomUUID());
                setIsAuthReady(true);
                setChatType('ephemeral'); 
                
                // R√©cup√©ration des pr√©f√©rences locales
                const storedNickname = localStorage.getItem('ashia_nickname');
                const storedLanguage = localStorage.getItem('ashia_lang');
                const storedTheme = localStorage.getItem('ashia_theme');
                const storedUserType = localStorage.getItem('ashia_usertype');

                if (storedNickname) {
                     setNickname(storedNickname);
                     setIsNicknameModalOpen(false); 
                } else {
                     setIsNicknameModalOpen(true);
                }

                if (storedLanguage) setLanguage(storedLanguage);
                if (storedTheme) setTheme(storedTheme);
                if (storedUserType) setUserType(storedUserType);
                

            }, []);

            // 2. Auto-scroll effect
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);


            // --- CHAT MANAGEMENT FUNCTIONS (D√©sactiv√©es) ---

            const newChat = (type = 'standard') => {
                setMessages([]);
                setCurrentChatId(null);
                setChatType('ephemeral'); 
                setIsMenuOpen(false); 
                setIsNewChatMenuOpen(false);
                setInput('');
            };
            
            const startNewStandardChat = () => newChat('standard'); 
            const startNewProjectChat = () => newChat('standard');
            const startNewEphemeralChat = () => newChat('ephemeral'); 

            // Les fonctions de persistance sont des stubs et n'effectuent aucune op√©ration Firestore
            const loadChat = async (chat) => { console.log("Fonction de chargement non disponible."); };
            const deleteChat = async (id) => { console.log("Fonction de suppression non disponible."); };
            const updateChatTitle = async (newTitle) => { console.log("Fonction de renommage non disponible."); }
            const saveChat = async (currentMessages) => { /* Ne fait rien */ };
            
            const getSystemInstruction = (type) => {
                 const langCode = language === 'fr' ? 'fran√ßais' : 'english';
                 // Instruction CL√â: Pas de Markdown. R√©ponse br√®ve.
                 const baseInstruction = `You are Ash.ia, a helpful AI assistant. Respond in ${langCode}. Your responses MUST be EXTREMELY BRIEF, direct, and contain NO Markdown formatting (no bold, italic, lists, emojis, etc. ‚Äì ONLY plain text in paragraphs, no *, **, #, or any formatting). ALWAYS end every response with one relevant follow-up question.`;

                 if (type === 'student') {
                     return `${baseInstruction} Act as an academic tutor. Focus on essential and pedagogical information.`;
                 }
                 if (type === 'professional') {
                     return `${baseInstruction} Act as a professional and strategic consultant. Focus on executive summaries and key recommendations.`;
                 }
                 return `${baseInstruction} Act as a general knowledgeable assistant.`; 
            };

            const callGeminiApi = async (messages, userPrompt, attempt = 1) => {
                 const systemPrompt = getSystemInstruction(userType); 
                
                 // NOTE: La v√©rification de longueur de cl√© API a √©t√© supprim√©e pour √©viter le message d'erreur
                 // personnalis√© suite √† une cl√© placeholder trop courte. L'√©chec se fera maintenant 
                 // via la connexion API standard si la cl√© n'est pas remplac√©e par une cl√© compl√®te et valide.

                 const chatHistory = messages.map(msg => ({
                     role: msg.role === 'user' ? 'user' : 'model', 
                     parts: [{ text: msg.text }]
                 }));

                 const payload = {
                     contents: chatHistory, 
                     tools: [{ "google_search": {} }],
                     systemInstruction: { parts: [{ text: systemPrompt }] },
                 };

                 try {
                     const response = await fetch(API_URL, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(payload)
                     });

                     if (!response.ok) {
                         if (response.status === 429 && attempt < MAX_RETRIES) {
                             const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                             await new Promise(resolve => setTimeout(resolve, delay));
                             return callGeminiApi(messages, userPrompt, attempt + 1);
                         }
                         throw new Error(`Erreur HTTP: ${response.status}`);
                     }

                     const result = await response.json();
                     const candidate = result.candidates?.[0];

                     if (candidate && candidate.content?.parts?.[0]?.text) {
                         const text = candidate.content.parts[0].text;
                         let sources = [];
                         const groundingMetadata = candidate.groundingMetadata;

                         if (groundingMetadata && groundingMetadata.groundingAttributions) {
                             sources = groundingMetadata.groundingAttributions
                                 .map(attribution => ({
                                     uri: attribution.web?.uri,
                                     title: attribution.web?.title,
                                 }))
                                 .filter(source => source.uri && source.title);
                         }

                         return { text, sources };

                     } else {
                         return { text: t.apiError, sources: [] };
                     }

                 } catch (error) {
                     console.error("Erreur lors de l'appel √† l'API Gemini:", error);
                     if (attempt < MAX_RETRIES) {
                         const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                         await new Promise(resolve => setTimeout(resolve, delay));
                         return callGeminiApi(messages, userPrompt, attempt + 1);
                     }
                     return { text: t.apiConnectionError, sources: [] };
                 }
            };

            const sendMessage = async (e) => {
                 e.preventDefault();
                 if (!input.trim() || isLoading) {
                     return;
                 }

                 const userMessage = input.trim();
                 setInput('');
                
                 const newMessages = [...messages, { role: 'user', text: userMessage }];
                 setMessages(newMessages);
                 setIsLoading(true);

                 try {
                     const { text, sources } = await callGeminiApi(newMessages, userMessage); 

                     const updatedMessages = [...newMessages, { role: 'assistant', text, sources }];
                     setMessages(updatedMessages);
                    
                     await saveChat(updatedMessages); // D√©sactiv√©

                 } catch (error) {
                     console.error("Erreur principale de l'application:", error);
                     const errorMessages = [...newMessages, { role: 'assistant', text: t.criticalError }];
                     setMessages(errorMessages);
                 } finally {
                     setIsLoading(false);
                 }
            };


            const resetAllSettings = () => {
                 if (window.confirm(t.resetConfirm)) {
                     setNickname('');
                     setUserType(null);
                     setMessages([]);
                     setCurrentChatId(null);
                     setChatType('ephemeral'); 
                     setIsSettingsModalOpen(false); 
                     setIsNicknameModalOpen(true); 
                     localStorage.removeItem('ashia_nickname'); 
                     localStorage.removeItem('ashia_lang');
                     localStorage.removeItem('ashia_theme');
                     localStorage.removeItem('ashia_usertype');
                 }
            };
            
            const handleSettingChange = (key, value) => {
                 switch (key) {
                     case 'userType':
                         setUserType(value);
                         if (value) {
                             localStorage.setItem('ashia_usertype', value);
                         } else {
                             localStorage.removeItem('ashia_usertype');
                         }
                         break;
                     case 'language':
                         setLanguage(value);
                         localStorage.setItem('ashia_lang', value);
                         break;
                     case 'theme':
                         setTheme(value);
                         localStorage.setItem('ashia_theme', value);
                         break;
                     default:
                         break;
                 }
            };
            
            // --- RENDER MODALS ---

            const NicknameModal = () => {
                 const [tempNickname, setTempNickname] = useState(''); 
                
                 useEffect(() => {
                     if (nickname) setTempNickname(nickname);
                 }, [nickname]);

                 const handleSaveNickname = () => {
                     if (!tempNickname.trim()) return;
                     setNickname(tempNickname.trim());
                     localStorage.setItem('ashia_nickname', tempNickname.trim()); 
                     setIsNicknameModalOpen(false);
                 };

                 const isFormValid = tempNickname.trim() && isAuthReady;

                 return (
                     <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 ${getThemeClasses('bg-main')} bg-opacity-95`}>
                         <div className={`w-full max-w-md p-6 rounded-xl shadow-2xl ${getThemeClasses('bg-modal')}`}>
                             <h2 className={`text-4xl font-bold mb-8 text-center ${getThemeClasses('text-primary')}`}>
                                 Ash.ia
                             </h2>

                             <div className="mb-6">
                                 <label className="block text-sm font-medium mb-2"></label>
                                 <input
                                     type="text"
                                     value={tempNickname}
                                     onChange={(e) => setTempNickname(e.target.value)}
                                     placeholder={t.nicknamePlaceholder} 
                                     className={`w-full p-3 rounded-lg outline-none ${getThemeClasses('bg-input')}`}
                                     onKeyDown={(e) => {
                                         if (e.key === 'Enter' && isFormValid) {
                                             handleSaveNickname();
                                         }
                                     }}
                                 />
                                 {!tempNickname.trim() && <p className="text-red-400 text-xs mt-2">{t.nicknameRequired}</p>}
                             </div>
                            
                             {/* CORRECTION DE L'ERREUR DE VALIDATION DOM (<div> dans <p>) : 
                                 Remplacement de <p> par <div> pour le statut d'authentification */}
                             <div className="mt-4 mb-6 text-sm text-center text-gray-400">
                                 {isAuthReady ? t.authStatus : (
                                     <div className="flex items-center justify-center text-yellow-500">
                                         <Icon name="Loader" className="w-3 h-3 mr-1 animate-spin" />
                                         {t.authLoading}
                                     </div>
                                 )}
                             </div>

                             <button
                                 onClick={handleSaveNickname}
                                 className={`w-full p-3 font-bold rounded-xl transition duration-200 ${getThemeClasses('btn-primary')} ${!isFormValid ? 'opacity-50 cursor-not-allowed' : ''}`}
                                 disabled={!isFormValid}
                             >
                                 {t.continueButton}
                             </button>
                         </div>
                     </div>
                 );
            };

            const SettingsModal = () => {
                
                 const handleCloseSettings = () => {
                      setIsSettingsModalOpen(false);
                 };

                 if (!nickname) return null;

                 return (
                     <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 ${getThemeClasses('bg-main')} bg-opacity-95`}>
                         <div className={`w-full max-w-md p-6 rounded-xl shadow-2xl ${getThemeClasses('bg-modal')}`}>
                             <div className="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
                                 <h2 className={`text-2xl font-bold ${getThemeClasses('text-primary')}`}>
                                     <Icon name="Settings" className="inline w-6 h-6 mr-2 icon-content" /> {translations[language].settingsTitle}
                                 </h2>
                                  <button 
                                     onClick={handleCloseSettings} 
                                     className={`p-1 rounded-full transition duration-150 ${getThemeClasses('btn-secondary')}`}
                                     title={translations[language].close}
                                 >
                                     <Icon name="X" className="w-6 h-6 icon-content" />
                                  </button>
                             </div>

                             {/* SECTION 1: PROFIL D'INTERACTION - AUTO-SAVE */}
                             <div className={`mb-8 p-4 rounded-lg ${getThemeClasses('bg-chat-card')}`}>
                                 <label className="block text-lg font-semibold mb-4 text-white">{translations[language].profileLabel}</label>
                                 <div className="flex flex-wrap justify-center space-x-2 sm:space-x-4">
                                    
                                     {/* Option G√©n√©rale */}
                                     <button
                                         type="button"
                                         onClick={() => handleSettingChange('userType', null)}
                                         className={`flex-1 flex flex-col items-center p-3 font-semibold rounded-xl border-2 transition duration-200 min-w-[30%] mb-2 ${
                                             userType === null 
                                             ? `border-yellow-500 ring-2 ring-yellow-500 ${getThemeClasses('btn-primary').replace('bg-indigo', 'bg-yellow').replace('text-white', 'text-gray-900')}` 
                                             : `border-gray-500 ${getThemeClasses('btn-secondary')}`
                                         }`}
                                     >
                                         <Icon name="CheckCircle" className="w-6 h-6 mb-1 icon-content" /> <span>{translations[language].typeGeneral}</span>
                                     </button>
                                    
                                     {/* Option √âtudiant */}
                                     <button
                                         type="button"
                                         onClick={() => handleSettingChange('userType', 'student')}
                                         className={`flex-1 flex flex-col items-center p-3 font-semibold rounded-xl border-2 transition duration-200 min-w-[30%] mb-2 ${
                                             userType === 'student' 
                                             ? `border-blue-500 ring-2 ring-blue-500 ${getThemeClasses('btn-primary').replace('bg-indigo', 'bg-blue')}` 
                                             : `border-gray-500 ${getThemeClasses('btn-secondary')}`
                                         }`}
                                     >
                                         <Icon name="GraduationCap" className="w-6 h-6 mb-1 icon-content" /> <span>{translations[language].student}</span>
                                     </button>
                                    
                                     {/* Option Professionnel */}
                                     <button
                                         type="button"
                                         onClick={() => handleSettingChange('userType', 'professional')}
                                         className={`flex-1 flex flex-col items-center p-3 font-semibold rounded-xl border-2 transition duration-200 min-w-[30%] mb-2 ${
                                             userType === 'professional' 
                                             ? `border-teal-500 ring-2 ring-teal-500 ${getThemeClasses('btn-primary').replace('bg-indigo', 'bg-teal')}` 
                                             : `border-gray-500 ${getThemeClasses('btn-secondary')}`
                                         }`}
                                     >
                                         <Icon name="Briefcase" className="w-6 h-6 mb-1 icon-content" /> <span>{translations[language].professional}</span>
                                     </button>
                                 </div>
                             </div>
                            
                             {/* SECTION 2: LANGUE & TH√àME - AUTO-SAVE */}
                             <div className={`mb-8 p-4 rounded-lg ${getThemeClasses('bg-chat-card')}`}>
                                 <h3 className="block text-lg font-semibold mb-4 text-white">Interface</h3>
                                    
                                 {/* Choix de la Langue */}
                                 <div className="mb-5">
                                     <label className="block text-sm font-medium mb-2">{translations[language].language}</label>
                                     <div className="flex justify-around space-x-2">
                                         {['fr', 'en'].map((lang) => (
                                             <button
                                                 key={lang}
                                                 onClick={() => handleSettingChange('language', lang)}
                                                 className={`flex-1 p-3 rounded-xl border-2 font-semibold capitalize transition-all duration-200 ${
                                                     language === lang
                                                         ? `${getThemeClasses('btn-primary')}`
                                                         : `${getThemeClasses('btn-secondary')} opacity-70`
                                                 }`}
                                             >
                                                 <Icon name="Globe" className="w-4 h-4 mr-1 icon-content" />
                                                 {lang === 'fr' ? 'Fran√ßais' : 'English'}
                                             </button>
                                         ))}
                                     </div>
                                 </div>

                                 {/* Choix du Th√®me */}
                                 <div>
                                     <label className="block text-sm font-medium mb-2">{translations[language].themeLabel}</label>
                                     <div className="flex justify-around space-x-2">
                                         {['dark', 'light', 'neon'].map((t) => (
                                             <button
                                                 key={t}
                                                 onClick={() => handleSettingChange('theme', t)}
                                                 className={`flex-1 p-3 rounded-xl border-2 font-semibold capitalize transition-all duration-200 ${
                                                     theme === t
                                                         ? `${getThemeClasses('btn-primary')}`
                                                         : `${getThemeClasses('btn-secondary')} opacity-70`
                                                 }`}
                                             >
                                                 {t === 'dark' ? translations[language].darkMode : t === 'light' ? translations[language].lightMode : translations[language].neonMode}
                                             </button>
                                         ))}
                                     </div>
                                 </div>
                             </div>
                            
                             <button
                                 onClick={handleCloseSettings}
                                 className={`w-full p-3 font-bold rounded-xl transition duration-200 ${getThemeClasses('btn-primary')}`}
                             >
                                 {translations[language].close}
                             </button>

                             <button
                                 onClick={resetAllSettings}
                                 className="w-full mt-4 p-3 font-bold rounded-xl text-xs bg-red-800 hover:bg-red-700 text-white transition duration-200"
                             >
                                 <Icon name="Trash2" className="w-3 h-3 mr-1 icon-content" /> {translations[language].resetSettings} ({nickname})
                             </button>
                         </div>
                     </div>
                 );
            };

            const EditTitleModal = () => {
                 if (!chatToEdit) return null;
                 const [newTitle, setNewTitle] = useState(chatToEdit.title);

                 const handleUpdate = (e) => {
                     e.preventDefault();
                     console.log("Renommage non disponible sans persistance.");
                     setIsTitleEditModalOpen(false);
                 };

                 return (
                     <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4">
                         <form onSubmit={handleUpdate} className={`w-full max-w-sm p-6 rounded-xl shadow-2xl ${getThemeClasses('bg-modal')}`}>
                             <h2 className={`text-xl font-bold mb-4 ${getThemeClasses('text-primary')}`}>
                                 <Icon name="Edit2" className="w-5 h-5 mr-2 icon-content" /> {t.renameChatTitle}
                             </h2>

                             <input
                                 type="text"
                                 value={newTitle}
                                 onChange={(e) => setNewTitle(e.target.value)}
                                 placeholder={t.newTitlePlaceholder}
                                 className={`w-full p-3 mb-4 rounded-lg outline-none ${getThemeClasses('bg-input')}`}
                                 maxLength={50}
                             />
                             <div className="flex justify-end space-x-3">
                                 <button
                                     type="button"
                                     onClick={() => setIsTitleEditModalOpen(false)}
                                     className={`p-2 px-4 rounded-lg font-semibold ${getThemeClasses('btn-secondary')}`}
                                 >
                                     {t.cancel}
                                 </button>
                                 <button
                                     type="submit"
                                     className={`p-2 px-4 rounded-lg font-semibold ${getThemeClasses('btn-primary')}`}
                                 >
                                     {t.save}
                                 </button>
                             </div>
                         </form>
                     </div>
                 );
            };
            
            const NewChatMenu = () => {
                 return (
                     <div className={`absolute top-14 right-0 z-30 w-56 p-2 rounded-xl shadow-2xl ${getThemeClasses('bg-modal')} flex flex-col space-y-2 border border-gray-700`}>
                         <button
                             onClick={startNewEphemeralChat}
                             className={`flex items-center p-3 rounded-lg text-sm font-semibold hover:opacity-80 transition duration-150 bg-gray-600 hover:bg-gray-500 text-white`}
                         >
                             <Icon name="Zap" className="w-5 h-5 mr-3 text-red-400 icon-content" /> {t.newEphemeral}
                         </button>
                         <button
                             onClick={startNewStandardChat}
                             className={`flex items-center p-3 rounded-lg text-sm font-semibold hover:opacity-80 transition duration-150 ${getThemeClasses('btn-secondary')}`}
                         >
                             <Icon name="PlusCircle" className="w-5 h-5 mr-3 text-white icon-content" /> {t.newChat}
                         </button>
                         <button
                             onClick={startNewProjectChat}
                             className={`flex items-center p-3 rounded-lg text-sm font-semibold hover:opacity-80 transition duration-150 ${getThemeClasses('btn-primary').replace('bg-indigo', 'bg-teal')}`}
                         >
                             <Icon name="Bookmark" className="w-5 h-5 mr-3 text-white icon-content" /> {t.newProject}
                         </button>
                     </div>
                 );
            };


            // --- RENDER SIDEBAR & CHAT SCREEN ---

            const renderSidebar = () => {
                 const getUserTypeLabel = (type) => {
                     switch (type) {
                         case 'student': return t.typeStudent;
                         case 'professional': return t.typeProfessional;
                         default: return t.typeGeneral;
                     }
                 };

                 return (
                     <div className={`fixed inset-y-0 left-0 z-20 w-80 ${getThemeClasses('bg-sidebar')} transform transition-transform duration-300 ease-in-out ${
                         isMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'
                     } flex flex-col p-4`}>
                        
                         <div className="flex justify-between items-center mb-6 pb-2 border-b border-gray-700">
                             <h2 className={`text-xl font-bold ${getThemeClasses('text-primary')}`}>{t.sidebarTitle}</h2>
                             <button 
                                 onClick={() => setIsMenuOpen(false)} 
                                 className={`p-2 rounded-full transition duration-150 ${getThemeClasses('btn-secondary')}`}
                             >
                                 <Icon name="X" className="w-6 h-6 icon-content" />
                             </button>
                         </div>
                        
                         {/* Message d'avertissement de non-sauvegarde */}
                         <div className="p-3 mb-4 bg-yellow-900/50 border border-yellow-700 rounded-lg text-sm text-yellow-300">
                             ‚ö†Ô∏è L'historique n'est pas sauvegard√© dans cette version de d√©monstration.
                         </div>

                         {/* Nouveaux boutons de chat - En haut de la sidebar */}
                         <div className="flex flex-col space-y-2 mb-6">
                             <button
                                 onClick={startNewProjectChat}
                                 className={`flex items-center justify-center p-3 font-bold rounded-xl transition duration-200 ${getThemeClasses('btn-primary')}`}
                             >
                                 <Icon name="Bookmark" className="w-5 h-5 mr-2 icon-content" /> {t.newProject}
                             </button>
                             <button
                                 onClick={startNewEphemeralChat}
                                 className={`flex items-center justify-center p-3 font-bold rounded-xl transition duration-200 bg-gray-600 hover:bg-gray-500 text-white`}
                             >
                                 <Icon name="Zap" className="w-5 h-5 mr-2 icon-content" /> {t.newEphemeral}
                             </button>
                         </div>


                         <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar">
                             <p className="text-gray-400 text-center mt-6">{t.noSavedChats}</p>
                         </div>
                     </div>
                 );
            };

            const renderChatScreen = () => {
                 const showWelcomeMessage = messages.length === 0 && !isTyping;
                
                 const chatTypeIndicator = chatType === 'ephemeral' ? (
                     <span className="text-sm text-red-400 font-semibold flex items-center">
                         <Icon name="Zap" className="w-4 h-4 mr-1 icon-content" /> {t.newEphemeral}
                     </span>
                 ) : (
                     currentChatId ? (
                          <span className="text-sm text-gray-400 truncate max-w-[200px]">{chats.find(c => c.id === currentChatId)?.title}</span>
                     ) : (
                         <span className="text-sm text-gray-400">{t.newChat}</span>
                     )
                 );

                 return (
                     <div className={`flex flex-col h-full relative ${getThemeClasses('bg-main')}`}>
                        
                         {/* Modales toujours au-dessus */}
                         {isNicknameModalOpen && <NicknameModal />}
                         {isSettingsModalOpen && <SettingsModal />}
                         {isTitleEditModalOpen && <EditTitleModal />}

                         {/* Overlay pour fermer le menu */}
                         {isMenuOpen && (
                             <div className="fixed inset-0 z-10 bg-black/50" onClick={() => setIsMenuOpen(false)}></div>
                         )}
                         {isNewChatMenuOpen && (
                             <div className="fixed inset-0 z-20" onClick={() => setIsNewChatMenuOpen(false)}></div>
                         )}
                        
                         {/* Ent√™te du chat */}
                         <header className={`flex items-center justify-between p-4 ${getThemeClasses('bg-header')} flex-shrink-0`}>
                            
                             <div className="flex items-center space-x-3">
                                 <button
                                     onClick={() => setIsMenuOpen(true)}
                                     className={`p-2 rounded-full transition duration-150 ${getThemeClasses('btn-secondary')}`}
                                     title={t.openHistory}
                                 >
                                     <Icon name="Menu" className="w-6 h-6 icon-content" />
                                 </button>
                             </div>

                             {/* Titre Centr√© */}
                             <div className="flex flex-col items-center absolute left-1/2 transform -translate-x-1/2">
                                 <h1 className="text-2xl font-bold">Ash.ia</h1> 
                                 {chatTypeIndicator}
                             </div>

                             {/* Groupe de boutons Droite : Param√®tres et Nouveau Chat (Menu) */}
                             <div className="flex items-center space-x-3 relative">
                                 <button
                                     onClick={() => setIsSettingsModalOpen(true)}
                                     className={`p-2 rounded-full transition duration-150 ${getThemeClasses('btn-secondary')}`}
                                     title={t.settings}
                                 >
                                     <Icon name="Settings" className="w-6 h-6 icon-content" />
                                 </button>
                                 <button
                                     onClick={() => setIsNewChatMenuOpen(prev => !prev)}
                                     className={`p-2 rounded-full transition duration-150 shadow-md ${getThemeClasses('btn-primary')}`}
                                     title={t.startNewChat}
                                 >
                                     {isNewChatMenuOpen ? <Icon name="X" className="w-6 h-6 icon-content" /> : <Icon name="PlusCircle" className="w-6 h-6 icon-content" />}
                                 </button>
                                 {isNewChatMenuOpen && <NewChatMenu />}
                             </div>
                         </header>

                         {/* Zone de messages */}
                         <main className={`flex-1 overflow-y-auto p-4 space-y-4 ${getThemeClasses('bg-main')} custom-scrollbar`}>
                            
                             {/* Message de bienvenue centr√© */}
                             {showWelcomeMessage && (
                                 <div className="absolute inset-0 flex flex-col items-center justify-center p-4 pointer-events-none">
                                     <p className="text-xl font-semibold text-center text-gray-400 transition-opacity duration-300"
                                         style={{ opacity: showWelcomeMessage ? 1 : 0 }}
                                     >
                                         {t.welcomeMessage(nickname)}
                                     </p>
                                      {userType ? (
                                         <p className="text-sm mt-2 text-gray-500">
                                             {t.profileSelected(userType === 'student' ? t.typeStudent : t.typeProfessional)}
                                         </p>
                                     ) : (
                                         <p className="text-sm mt-2 text-gray-500">
                                             {t.profileGeneral}
                                         </p>
                                     )}
                                 </div>
                             )}

                             {messages.map((msg, index) => (
                                 <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                     <div className={`max-w-[85%] p-3 rounded-xl ${
                                         msg.role === 'user' 
                                         ? getThemeClasses('bg-user') + ' rounded-br-none'
                                         : getThemeClasses('bg-ash') + ' rounded-tl-none'
                                     }`}>
                                         <p className="whitespace-pre-wrap">{msg.text}</p>
                                        
                                         {/* Affichage des sources pour l'assistant */}
                                         {msg.role === 'assistant' && msg.sources && msg.sources.length > 0 && (
                                             <div className={`mt-3 pt-2 border-t border-gray-700 text-xs ${getThemeClasses('bg-ash').includes('dark') ? 'text-gray-400' : 'text-gray-500'}`}>
                                                 <p className="mb-1 font-semibold">{t.sources}</p>
                                                 <ul className="space-y-1">
                                                     {msg.sources.map((source, idx) => (
                                                         <li key={idx}>
                                                             <a 
                                                                 href={source.uri} 
                                                                 target="_blank" 
                                                                 rel="noopener noreferrer" 
                                                                 className={`hover:${getThemeClasses('text-primary')} transition duration-150 flex items-center`}
                                                             >
                                                                 <Icon name="ExternalLink" className="w-3 h-3 mr-1 icon-content" />
                                                                 {source.title.length > 50 ? source.title.substring(0, 50) + '...' : source.title}
                                                             </a>
                                                         </li>
                                                     ))}
                                                 </ul>
                                             </div>
                                         )}
                                     </div>
                                 </div>
                             ))}

                             {/* Indicateur de chargement : Ash r√©fl√©chi */}
                             {isLoading && (
                                 <div className="flex justify-start">
                                     <div className={`max-w-xs p-3 rounded-xl ${getThemeClasses('bg-ash')} rounded-tl-none shadow-lg flex items-center`}>
                                         <Icon name="Loader" className={`w-4 h-4 mr-2 animate-spin ${getThemeClasses('text-primary')} icon-content`} />
                                         <span className="text-sm font-bold">{t.thinking}</span>
                                     </div>
                                 </div>
                             )}
                             <div ref={messagesEndRef} />
                         </main>

                         {/* Formulaire de saisie */}
                         <footer className={`p-3 ${getThemeClasses('bg-header')} flex-shrink-0`}>
                             <form onSubmit={sendMessage} className="flex items-center">
                                 <input
                                     type="text"
                                     value={input}
                                     onChange={(e) => setInput(e.target.value)}
                                     placeholder={t.sendPlaceholder}
                                     className={`flex-1 p-3 mr-3 rounded-full outline-none transition duration-150 placeholder-gray-400 ${getThemeClasses('bg-input')}`}
                                     disabled={isLoading}
                                 />
                                 <button
                                     type="submit"
                                     className={`p-3 rounded-full transition duration-150 shadow-xl ${getThemeClasses('btn-primary')} ${
                                         !input.trim() || isLoading
                                         ? 'opacity-50 cursor-not-allowed'
                                         : 'transform active:scale-95'
                                     }`}
                                     disabled={!input.trim() || isLoading}
                                 >
                                     <Icon name="Send" className="w-6 h-6 icon-content" />
                                 </button>
                             </form>
                         </footer>
                        
                         {/* Sidebar */}
                         {renderSidebar()}
                     </div>
                 );
            };
            
            return (
                 <div className={`h-screen w-screen overflow-hidden ${getThemeClasses('bg-app')} ${theme === 'neon' ? 'neon-text-shadow' : ''}`}>
                      <CustomStyles />
                      {renderChatScreen()}
                 </div>
            );
        };
        
        // Rendu de l'application dans la balise div#root
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
